<analysis>**original_problem_statement:**
L'utente ha richiesto un'ampia revisione dell'applicazione, con un focus principale sulla gestione degli F24. Le richieste includono:
1.  **Refactoring Parser F24 (Critico):** Risolvere in modo definitivo il problema del parser F24 che non estraeva correttamente tutti i codici tributo, in particolare i codici IRAP (3800, 3812, 3813) e i tributi locali (IMU, etc.). L'utente ha richiesto di abbandonare le regex in favore di un metodo più robusto.
2.  **Unificazione Interfaccia F24:** Unire le pagine  e  in un'unica interfaccia centralizzata per gestire l'intero ciclo di vita degli F24: caricamento, visualizzazione, pagamento, riconciliazione con quietanze e cancellazione.
3.  **Miglioramento Riconciliazione:**
    *   Implementare l'upload massivo sia per gli F24 che per le quietanze.
    *   Creare un processo di Riconciliazione automatica che associ le quietanze agli F24 corretti.
    *   Rendere le card riepilogative (es. F24 Pagati) cliccabili per visualizzare in un modale i dettagli delle associazioni, incluse le discrepanze di importo.
4.  **Correzione Bug:**
    *   Risolvere un errore  sul pulsante Paga.
    *   Risolvere un errore  durante l'eliminazione di un F24.
    *   Impedire che il caricamento di nuovi F24 cancelli quelli esistenti, implementando una chiave di univocità.
5.  **Miglioramento UI/UX:** Rendere le righe della tabella F24 espandibili per mostrare il dettaglio di tutti i tributi estratti.
6.  **Integrazione Parser Buste Paga:** Integrare il parser per le buste paga Zucchetti, già creato ma non utilizzato.
7.  **Nuove Funzionalità (XML):** Aggiungere la possibilità di caricare dati da file XML per  e .

**User's preferred language**: Italiano

**what currently exists?**
L'applicazione ha subito un'importante trasformazione nella gestione degli F24. Il parser F24 () è stato completamente riscritto utilizzando  per un'estrazione basata su coordinate e analisi testuale, abbandonando le fragili espressioni regolari. Ora è in grado di estrarre correttamente tributi da tutte le sezioni (ERARIO, INPS, REGIONI, IMU/Locali), inclusi i codici IRAP che prima venivano saltati.

L'interfaccia utente è stata unificata nella pagina  (), che ora centralizza tutte le funzionalità. Questa pagina include:
*   Bottoni per il caricamento massivo di F24 e Quietanze.
*   Un bottone Riconcilia che avvia un processo di matching automatico tra F24 e quietanze.
*   Card riepilogative cliccabili che aprono modali con i dettagli delle liste (F24 da Pagare, Pagati, Quietanze, Alert).
*   Una tabella di F24 con righe espandibili per visualizzare il dettaglio di tutti i tributi estratti.

Sono stati corretti numerosi bug, tra cui gli errori 403 (Paga) e 400 (Elimina), ed è stata implementata una logica di deduplica per gli upload.

**Last working item**:
- **Last item agent was working**: L'agente stava perfezionando il parser F24 () per risolvere un problema di duplicazione e per completare la lista dei codici tributo. In particolare, stava affrontando il fatto che alcuni codici (es. , sanzione IRAP) venivano erroneamente inclusi sia nella sezione ERARIO che in quella REGIONI. Inoltre, l'utente aveva chiesto di integrare tutti i codici tributo dal sito dell'Agenzia delle Entrate e di correggere l'estrazione dei codici  e  da specifici file PDF.
- **Status**: IN PROGRESS
- **Agent Testing Done**: Y
- **Which testing method agent to use?**: backend testing agent per validare il parser contro tutti i PDF F24 forniti, assicurandosi che non ci siano duplicati né codici mancanti. Successivamente, frontend testing agent per verificare che la UI nella pagina  mostri correttamente i totali per sezione e i dettagli espansi.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1**: (P0) Il parser F24, sebbene molto migliorato, crea ancora duplicati per alcuni tributi.
- **Issue 2**: (P1) Il parser delle buste paga è pronto ma non integrato.
- **Issue 3**: (P2) La gestione delle transazioni PRELIEVO ASSEGNO non è stata ancora implementata.
- **Issue 4**: (P2) La logica di matching F24-Quietanza è basica e ha prodotto associazioni errate (es. F24 da 200€ associato a quietanza da 838€).

**Issues Detail**:
- **Issue 1**:
  - **Description**: Il parser F24 in , durante l'analisi della sezione ERARIO, cattura anche righe che appartengono alla sezione REGIONI, specialmente quando un codice tributo regionale (es. sanzione IRAP ) inizia con una cifra () che il pattern ERARIO riconosce. Questo causa la visualizzazione dello stesso tributo in due sezioni diverse.
  - **Attempted fixes**: L'agente ha ampliato i pattern di riconoscimento per la sezione REGIONI per includere più codici, ma non ha aggiunto una logica di esclusione nella sezione ERARIO per evitare la doppia cattura.
  - **Next debug checklist**:
    1.  Modificare la funzione di parsing della sezione ERARIO in  per aggiungere un controllo: se una riga contiene un codice regione valido (es. 0 5), deve essere ignorata da questo parser e lasciata a quello delle REGIONI.
    2.  Completare la richiesta dell'utente di collezionare TUTTI i codici tributo dal sito dell'Agenzia delle Entrate, non solo quelli IRAP, per rendere il dizionario del parser il più completo possibile.
    3.  Eseguire test di regressione su tutti i PDF F24 forniti per garantire che la correzione non introduca nuovi problemi.
  - **Why fix this issue and what will be achieved with the fix?**: Risolverà le discrepanze nei totali e fornirà un riepilogo dei tributi corretto al 100%, aumentando l'affidabilità della funzione più critica dell'app.
  - **Status**: IN PROGRESS
  - **Is recurring issue?**: Y
  - **Should Test frontend/backend/both after fix?**: Both
  - **Blocked on other issue**: No.

- **Issue 2**:
  - **Description**: Esiste un parser per le buste paga Zucchetti (), ma manca l'infrastruttura per utilizzarlo: non c'è un endpoint API dedicato né un'interfaccia frontend per l'upload dei file.
  - **Status**: NOT STARTED
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Both

- **Issue 3**:
  - **Description**: Una richiesta pendente da una sessione precedente per gestire correttamente le transazioni PRELIEVO ASSEGNO nella Riconciliazione Smart.
  - **Status**: NOT STARTED
  - **Is recurring issue?**: Y
  - **Should Test frontend/backend/both after fix?**: Backend

- **Issue 4**:
  - **Description**: L'algoritmo di riconciliazione automatica tra F24 e quietanze è troppo semplice (probabilmente basato solo sulla vicinanza dell'importo) e crea associazioni errate, causando confusione.
  - **Next debug checklist**:
    1.  Rivedere la logica nell'endpoint .
    2.  Migliorare l'algoritmo affinché consideri più fattori: importo esatto, data di pagamento vicina alla scadenza, e idealmente corrispondenza di alcuni codici tributo.
    3.  Introdurre una soglia di confidenza per i match automatici.
  - **Why fix this issue and what will be achieved with the fix?**: Renderà la funzione di riconciliazione automatica affidabile e veramente utile, riducendo il lavoro manuale.
  - **Status**: NOT STARTED
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Both

**In progress Task List**:
Nessuno.

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
  - **(P1) Integrazione Parser Buste Paga**: Creare l'endpoint e l'UI per l'upload e il parsing delle buste paga.
  - **(P1) Caricamento  da XML**: Implementare la funzionalità per importare i dati dei salari da file XML.
  - **(P1) Caricamento dati Fornitori da XML**: Implementare l'importazione da XML nella pagina .
- **Future Tasks**:
  - **(P2) Frontend per Upload Estratti Conto (Nexi)**.
  - **(P3) Implementare la sezione HACCP**.
  - **(P3) Automazione Download Email per Estratti Conto**.

**Completed work in this session**
- **Risoluzione Criticità Parser F24**: Il parser è stato riscritto per utilizzare  ed è ora in grado di leggere correttamente la maggior parte dei tributi, inclusi IRAP (, ) e tributi locali, risolvendo il blocco principale dell'utente.
- **Unificazione Pagina F24**: Le pagine  e  sono state fuse in un'unica, potente pagina  () che centralizza tutte le operazioni.
- **Miglioramento UI/UX F24**:
  - Implementato l'upload massivo per F24 e quietanze.
  - Aggiunto un pulsante Riconcilia per il matching automatico.
  - Le card riepilogative e le righe della tabella sono ora interattive (cliccabili/espandibili) e mostrano dettagli in modali o sezioni a comparsa.
- **Bug Fixing**:
  - Risolti gli errori  (Paga) e  (Elimina) negli endpoint F24.
  - Implementata una chiave di univocità () per prevenire la sovrascrittura di dati durante l'upload.
- **Refactoring Codice**:
  - Rinominato e riorganizzato il codice del parser in .
  - Aggiornati tutti gli  nel backend per puntare al nuovo parser.
  - La pagina  è stata completamente riscritta per integrare tutte le nuove funzionalità.

**Earlier issues found/mentioned but not fixed**
- **Gestione PRELIEVO ASSEGNO**: Issue ricorrente da una fork precedente, non ancora affrontata.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork**: Mancata gestione delle transazioni PRELIEVO ASSEGNO.
- **Recurrence count**: 3+
- **Status**: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
- **PDF Parsing (Python/PyMuPDF)**: Utilizzo avanzato di PyMuPDF per estrarre testo e le sue coordinate, permettendo un parsing strutturato basato sulla posizione degli elementi nel PDF, superando i limiti delle regex.
- **UI/UX (React)**: Creazione di un'interfaccia complessa e unificata con stato gestito tramite  e . Implementazione di componenti interattivi come modali, tab, card cliccabili e righe di tabella espandibili.
- **API Development (FastAPI)**: Aggiunta di nuovi endpoint per operazioni complesse come la riconciliazione batch (), l'upload multiplo di file e la gestione idempotente delle risorse tramite chiavi univoche.
- **Data Deduplication**: Introduzione di una chiave composita ( +  + ) per identificare univocamente un F24 ed evitare duplicati nel database.

**key DB schema**
Nessuna modifica allo schema, ma la logica applicativa ora utilizza il campo  nella collection degli F24 per la deduplica.

**changes in tech stack**
Nessun cambiamento.

**All files of reference**
- : Il cuore della logica di parsing F24, dove va risolto il problema della duplicazione.
- : Il router FastAPI che contiene tutti gli endpoint per la gestione F24, incluso quello per la riconciliazione da migliorare.
- : La pagina React unificata che contiene tutta l'interfaccia utente per la gestione F24.
- : File di routing principale di React.

**Areas that need refactoring**:
- La funzione  in  necessita di un algoritmo di matching più intelligente per evitare associazioni errate.
- Il file  è molto lungo; potrebbe beneficiare di una struttura a classi per organizzare meglio le logiche di parsing delle diverse sezioni.

**key api endpoints**
- : (Creato) Esegue il matching automatico tra F24 e quietanze.
- : (Creato) Permette l'upload massivo di file di quietanza.
- : (Modificato) Endpoint per l'upload di F24 con logica di deduplica.
- : (Modificato) Reso più robusto per gestire tentativi di eliminazione multipla.
- : (Creato) Segna un F24 come pagato manualmente.
- : (Creato) Fornisce il file PDF di un F24 per la visualizzazione nel frontend.

**Critical Info for New Agent**
- **La priorità assoluta è il parser F24**: L'utente è molto attento ai dettagli. Ogni codice tributo mancante o duplicato verrà notato. Risolvere il problema della doppia contabilizzazione (ERARIO/REGIONI) è il prossimo passo fondamentale.
- **Completezza dei dati**: L'utente ha chiesto esplicitamente di usare il sito dell'Agenzia delle Entrate come fonte per tutti i codici tributo. Questa operazione va completata.
- **UI Unificata**: Non creare nuove pagine per la gestione F24. Tutto il lavoro deve convergere sulla pagina , migliorandola ulteriormente.
- **Affidabilità della Riconciliazione**: L'algoritmo di matching automatico è il prossimo punto debole da affrontare dopo il parser. Un matching inaffidabile rende la funzione inutile.

**documents and test reports created in this job**
Nessuno.

**Last 10 User Messages and any pending HUMAN messages**
- **10. (PENDING)** Richiede di scaricare tutti i codici tributo dal sito dell'Agenzia delle Entrate. Segnala che mancano i codici  e  da specifici file PDF e chiede di migliorare la visualizzazione della sezione REGIONI.
- **9.** Segnala che le due pagine F24 sono identiche e mancano le funzionalità della vecchia pagina di riconciliazione. (RISOLTO, le pagine sono state unite correttamente).
- **8.** Risponde a una domanda dell'agente sulla riconciliazione, specificando che l'associazione non è stata fatta con l'estratto conto. Chiede di poter vedere l'associazione F24/quietanza e di rendere le righe espandibili. (IMPLEMENTATO)
- **7.** Segnala che l'associazione automatica F24/quietanza è errata e che le card non sono tutte cliccabili. Chiede di aggiungere un upload massivo per gli F24 e un bottone Riconcilia. (IMPLEMENTATO)
- **6.** Riassume le correzioni: parser rinominato, errore 403 risolto. Spiega il flusso desiderato per le quietanze (upload multiplo, matching automatico, doppio controllo con protocollo). (IMPLEMENTATO)
- **5.** Chiede di rinominare il parser per evitare confusione. Chiede spiegazioni sulla differenza tra  e  e sulla funzione quietanza. Segnala errore 403 sui bottoni Paga. (RISOLTO)
- **4.** Segnala che i tributi locali/IMU (3847, 3848) sono stati estratti ma non sono visibili nell'interfaccia. (RISOLTO, aggiunta sezione IMU nel frontend).
- **3.** Conferma che i tributi da lui indicati sono stati estratti correttamente.
- **2.** Fornisce un PDF F24 e un file JNLP, chiedendo di analizzarli perché il parser non legge tutti i tributi. (RISOLTO, il parser è stato corretto e ora li legge).
- **1.** Fornisce un file ZIP e un JNLP, menzionando che mancano dei tributi e chiedendo se possono essere utili per la lettura degli F24. (ANALIZZATO, ha portato all'aggiunta di nuovi codici IMU/locali).

**Project Health Check:**
- **Broken**: NO. Le funzionalità critiche sono state ripristinate e notevolmente migliorate. Ci sono ancora imprecisioni da risolvere.
- **Mocked**: La sezione HACCP è assente. L'integrazione del parser delle buste paga è mancante.
- **Technical Debt**: Il file  è funzionale ma molto esteso e complesso. La logica di matching in  è ancora troppo semplice e rappresenta un debito da saldare per rendere la funzione affidabile.

**3rd Party Integrations**
-  (fitz): Utilizzato intensamente per il parsing dei PDF.
- Nessuna nuova integrazione.

**Testing status**
- **Testing agent used after significant changes**: NO
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: Nessuno.
- **Known regressions**: Nessuna.

**Credentials to test flow:**
Nessuna.

**What agent forgot to execute**
- Non ha completato la richiesta di scaricare **tutti** i codici tributo dal sito dell'Agenzia delle Entrate, concentrandosi solo su quelli IRAP e su quelli presenti nei file forniti.
- Non ha ancora affrontato il task pendente sulla gestione dei PRELIEVO ASSEGNO.
- Non ha iniziato a lavorare sull'integrazione del parser delle buste paga o sull'importazione da XML.</analysis>
