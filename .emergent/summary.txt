<analysis>**original_problem_statement:**
L'utente ha richiesto una serie di modifiche significative, cambiando radicalmente la direzione del progetto.
1.  **Eliminazione Modulo HACCP (COMPLETATO):** A causa di insoddisfazione, l'utente ha richiesto la rimozione completa e immediata di tutte le pagine, componenti, endpoint API e logiche di backend relative al modulo HACCP (Ricettario, Libro Allergeni, Temperature, Sanificazione, ecc.).
2.  **Semplificazione Logica Corrispettivi (COMPLETATO):** L'utente ha richiesto di eliminare l'importazione dei corrispettivi tramite file Excel. La nuova logica prevede:
    *   Inserimento manuale in Prima Nota come fonte primaria.
    *   L'importazione da file XML dei registratori telematici deve:
        *   Aggiornare un corrispettivo manuale esistente (trovato per data) con i dettagli IVA.
        *   Creare un nuovo movimento in prima nota se non esiste un corrispettivo manuale per quella data.
3.  **Nuovo Sistema Food Cost per Ricette (IN CORSO):** L'utente ha richiesto una nuova funzionalità per il calcolo preciso del food cost nelle ricette. Questo sistema deve includere:
    *   Un **Dizionario Prodotti** centralizzato, popolato automaticamente da tutte le righe delle fatture dei fornitori, contenente nome prodotto, peso/unità e prezzo al kg/lt (al netto dell'IVA).
    *   Un'interfaccia nella pagina delle ricette che, durante l'aggiunta di un ingrediente, mostri un **menu a tendina con autocompletamento** per selezionare un prodotto dal dizionario.
    *   Un sistema di calcolo automatico del costo dell'ingrediente basato sulla proporzione tra la quantità usata nella ricetta e il costo unitario del prodotto (es. 100g di un prodotto che costa 10€/kg devono essere calcolati come 1€).
    *   Un meccanismo per evidenziare i prodotti nel dizionario a cui mancano dati essenziali (peso/unità) per permettere all'utente di inserirli manualmente.

**User's preferred language**: Italiano

**what currently exists?**
L'applicazione è un ERP con moduli di contabilità e magazzino.
-   **Modulo HACCP e Ricettario:** L'intero modulo è stato **completamente eliminato** dal frontend e dal backend su richiesta esplicita dell'utente.
-   **Logica Corrispettivi:** La logica è stata semplificata. L'importazione da Excel è stata rimossa. Ora i corrispettivi vengono inseriti manualmente, e i file XML servono ad arricchire i dati con i dettagli dell'IVA o a creare nuove voci se mancanti.
-   **Filtro Anno Globale:** Un filtro anno globale, gestito tramite , è stato implementato con successo su oltre 15 pagine dell'applicazione, garantendo un'esperienza utente coerente.
-   **Logica Contabile:** È stato corretto un bug critico che causava la mancata registrazione dell'IVA nelle entrate da corrispettivi, sanando i dati pregressi per l'anno 2025. È stata creata una UI nella pagina Admin per monitorare lo stato della sincronizzazione dei dati.
-   **Dizionario Prodotti:** È stato creato il file base per il nuovo router backend () per gestire il dizionario prodotti, che servirà al nuovo sistema di food cost.

**Last working item**:
- **Last item agent was working**: L'agente stava implementando il nuovo sistema di calcolo del **Food Cost**. Aveva appena creato il router backend per il dizionario prodotti () e registrato nel . Stava modificando la pagina  per aggiungere uno stato per il dizionario, le funzioni per caricarlo e stava per integrare un componente di autocompletamento nel modal di modifica degli ingredienti per permettere la selezione da questo dizionario.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: both. Il backend (nuovo endpoint per il dizionario) necessita di test tramite . Il frontend () richiede test tramite  per verificare il nuovo componente di autocompletamento e il calcolo del costo. Al completamento, un  può verificare l'intero flusso.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1: (P1) Implementare la Sincronizzazione Dati Relazionale**
  - **Description**: L'utente ha richiesto che la modifica di un dato (es. una fattura) in una sezione si rifletta automaticamente in tutte le altre sezioni. La richiesta iniziale è stata parzialmente gestita con la creazione di una pagina di monitoraggio. L'utente ha poi de-prioritizzato a P2 il task specifico di associare le fatture ai pagamenti in cassa.
  - **Attempted fixes**: È stata creata una pagina UI in  per visualizzare lo stato della sincronizzazione e lanciare alcuni script di matching.
  - **Next debug checklist**:
    1.  Progettare e implementare update hooks o un servizio centralizzato che venga invocato alla modifica di entità chiave (Fatture, PrimaNota, Fornitori) per propagare le modifiche.
    2.  Implementare il task di  come richiesto (attualmente priorità P2).
  - **Why fix this issue and what will be achieved with the fix?**: Garantire la coerenza e l'integrità dei dati in tutta l'applicazione.
  - **Status**: IN PROGRESS
  - **Should Test frontend/backend/both after fix?**: both
  - **Blocked on other issue**: None

**In progress Task List**:
- **Task 1: (P0) Completare il Sistema di Food Cost e Dizionario Prodotti**
  - **Where to resume**:
    1.  **Backend**: Implementare la logica in  per scandagliare la collection , estrarre tutte le righe delle fatture, e creare un dizionario di prodotti unico con nome, prezzo/kg e peso/unità.
    2.  **Frontend**: In , completare l'integrazione del componente di autocompletamento per la selezione degli ingredienti dal dizionario.
    3.  **Frontend**: Implementare la logica di calcolo automatico del food cost quando un ingrediente e la sua quantità vengono aggiunti/modificati.
  - **What will be achieved with this?**: Fornirà un calcolo del food cost preciso e automatizzato, migliorerà la tracciabilità e standardizzerà i nomi degli ingredienti.
  - **Status**: IN PROGRESS
  - **Should Test frontend/backend/both after fix?**: both
  - **Blocked on something**: None

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
    - **(P2) Completare associazione fatture a pagamenti:** Associare le fatture caricate via XML ai pagamenti in cassa (dal file excel) e marcare le restanti come da pagare tramite banca, con possibilità di modifica manuale. (Richiesta dell'utente in , poi de-prioritizzata in chat).
- **Future Tasks**:
    - **(P2) Completare Refactoring Responsive (in Pausa):** Riprendere il task di rendere l'intera applicazione mobile-friendly, attualmente sospeso su richiesta dell'utente.

**Completed work in this session**
- **Eliminazione completa del Modulo HACCP (DONE):** Rimosse ~23 pagine frontend, i router backend (, ), le voci di menu e le chiamate API associate.
- **Semplificazione Logica Corrispettivi (DONE):** Rimosso l'endpoint di importazione da Excel, aggiornata la logica di importazione da XML, e rimossi i relativi pulsanti dalla UI.
- **Filtro Anno Globale (DONE):** Convertite con successo più di 15 pagine per utilizzare un contesto globale per l'anno, testato e verificato dal testing agent.
- **Correzione Logica Entrate Corrispettivi (DONE):** Identificato e corretto un bug critico dove l'IVA non veniva inclusa nelle entrate. Creato e eseguito uno script di fix per sanare 346 movimenti nel DB.
- **UI di Sincronizzazione Dati (DONE):** Aggiunta una nuova tab Sincronizzazione nella pagina Admin per monitorare lo stato dei dati e lanciare azioni di matching.
- **Hint Metodo Pagamento Fornitore (DONE):** Implementato un suggerimento nella pagina Dettaglio Fattura che mostra il metodo di pagamento predefinito del fornitore.

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, MongoDB.
- **Frontend:** React, stili JavaScript inline.
- **State Management:** React Context API ().
- **Data Integrity:** L'agente ha dovuto affrontare problemi di integrità dei dati (IVA mancante) e ha iniziato a costruire strumenti per la sincronizzazione e la coerenza (pagina Admin, dizionario prodotti).
- **Product Dictionary:** Un nuovo concetto introdotto per centralizzare le informazioni sui prodotti acquistati, derivate direttamente dalle fatture, per calcoli di costo e tracciabilità.

**key DB schema**
- : 
- : 
-  (Proposto): 

**All files of reference**
-  (File principale per la nuova funzionalità di food cost)
-  (Nuovo router per la logica del dizionario prodotti)
-  (Contiene la nuova UI per la sincronizzazione)
-  (Contiene la nuova logica di importazione XML dei corrispettivi)

**Critical Info for New Agent**
- **Focalizzazione attuale:** La priorità assoluta è completare il sistema di Food Cost e Dizionario Prodotti. L'utente ha fornito requisiti dettagliati per questa funzionalità.
- **HACCP è stato eliminato:** Non dedicare tempo a nulla che riguardi HACCP, ricette (nella sua vecchia forma), allergeni, ecc. L'utente era molto insoddisfatto e ha chiesto la rimozione totale. La pagina  è stata mantenuta ma deve essere riadattata per il nuovo sistema di food cost.
- **Logica Corrispettivi:** La logica di importazione dei corrispettivi è stata cambiata radicalmente. L'import da Excel non esiste più. Fare riferimento alla nuova logica manuale + XML per qualsiasi lavoro futuro in quest'area.
- **Struttura Progetto:** Il codice backend principale si trova in , non in .

**Last 10 User Messages and any pending HUMAN messages**
- **10. Richiesta Food Cost System:** L'utente ha descritto in dettaglio il nuovo sistema di food cost per le ricette, con dizionario prodotti, menu a tendina e calcolo automatico. (IN CORSO)
- **9. Eliminazione HACCP:** L'utente, insoddisfatto, ha ordinato di eliminare completamente tutte le pagine e le sezioni HACCP. (COMPLETATO)
- **8. Semplificazione Corrispettivi:** L'utente ha ordinato di rimuovere l'importazione da Excel e ha definito la nuova logica (manuale + XML). (COMPLETATO)
- **7. Spiegazione Corrispettivi:** L'utente ha chiesto una spiegazione dettagliata di come funziona la logica di inserimento dei corrispettivi. (COMPLETATO)
- **6. Completamento Task HACCP:** L'agente ha finito di riorganizzare le pagine HACCP e chiede all'utente se desidera eliminare i file obsoleti. (SUPERSEDED)
- **5. Riorganizzazione HACCP:** L'utente ha dato istruzioni per correggere il libro allergeni e riorganizzare le card e le pagine della sezione HACCP, de-prioritizzando il matching fatture a P2. (COMPLETATO, POI ELIMINATO)
- **4. Completamento Task P1:** L'agente ha completato i task P1 (metodo di pagamento e UI prima nota) e chiede di passare al successivo. (COMPLETATO)
- **3. Direttiva Task P1:** L'utente ha indicato di procedere con i task P1. (COMPLETATO)
- **2. Completamento Task P0:** L'agente ha completato i task P0 (filtro anno e logica entrate), ha presentato un piano per i task P1 e ha chiesto quale affrontare. (COMPLETATO)
- **1. Direttiva di continuare:** L'utente ha risposto P1.

**Project Health Check:**
- **Broken**: La sincronizzazione relazionale dei dati tra i moduli è ancora incompleta.
- **Mocked**: Nessuno.
- **Technical Debt**: Significativo. Il modulo HACCP è stato rimosso bruscamente, potrebbero esserci riferimenti residui minori. Mancanza di test automatici.

**3rd Party Integrations**
- : Utilizzata in passato per chiamate LLM (Claude Sonnet 4.5), ora non più utilizzata dopo la rimozione del modulo HACCP.
- , : Utilizzate per il parsing di file Excel.  è meno rilevante ora che l'importazione dei corrispettivi da Excel è stata rimossa.
- : Utilizzata per la manipolazione di immagini (es. logo).

**Testing status**
- **Testing agent used after significant changes**: YES (per il filtro anno globale).
- **Test files created**: Nessuno.
- **Known regressions**: Nessuna nota, ma la rimozione massiva del codice HACCP potrebbe aver introdotto effetti collaterali non ancora scoperti.

**What agent forgot to execute**
- Nulla. L'agente ha seguito le istruzioni dell'utente in modo sequenziale e stava lavorando sull'ultima richiesta esplicita. I task precedenti (come il P2 per il matching fatture) sono stati consapevolmente messi in backlog su indicazione dell'utente.</analysis>
