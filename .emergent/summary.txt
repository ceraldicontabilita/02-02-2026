<analysis>**original_problem_statement:**
L'utente ha fornito un elenco completo di nuove richieste, bug e modifiche di priorità. Le richieste principali sono:

**Requisiti Critici (P0):**
1.  **Correzione Bug:** Risolvere problemi su , temperature HACCP, esportazione Excel, , e paginazione di . Rimuovere il pulsante Esporta JSON da . (Questi sono stati completati).
2.  **Gestione TFR (Rielaborazione):** Leggere i dati dai PDF delle buste paga, tracciare acconti e aggiungere una sezione per l'inserimento manuale di acconti/prestiti. (La gestione manuale acconti è stata implementata).
3.  **Sistema HACCP (Sostituzione):** L'utente ha fornito due file ZIP (, ) con un sistema HACCP V2 completo, chiedendo di sostituire completamente la logica esistente con quella nuova, eliminando ogni traccia della vecchia.

**Miglioramenti UI/UX (P1):**
1.  **UI Compatta:** Ridurre le dimensioni di testi, card e spaziature su **tutte** le pagine.
2.  **Logo Aziendale:** Inserire il logo da  in tutte le pagine e nei PDF.
3.  **Filtro Annuale Globale:** Assicurarsi che **tutte** le pagine filtrino i dati per l'anno selezionato.

**Nuove Funzionalità e Modifiche (P1-P2):**
1.  **Cedolini:** Completare il modulo con paga oraria, maggiorazioni, assenze, malattia.
2.  **Cespiti:** Permettere modifica/cancellazione e preparare per la lettura dati da un PDF di bilancio.
3.  **Previsioni Acquisti:** Semplificare aggregando per tipologia di prodotto.
4.  **Archivio Bonifici:** Migliorare l'associazione con i cedolini e aggiungere download ZIP.
5.  **Riconciliazione Batch:** Ottimizzare l'endpoint per evitare timeout.
6.  **Keep-Alive Server:** Impedire che l'applicazione vada in standby.

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha completato con successo una serie di task critici. Innanzitutto, ha corretto tutti i bug P0 segnalati, ripristinando la funzionalità di , l'esportazione Excel, la documentazione API su , la paginazione e le statistiche della pagina Admin. Successivamente, ha implementato la gestione manuale degli acconti per i dipendenti (TFR, ferie, prestiti), aggiungendo un nuovo tab nell'interfaccia utente.

Infine, su richiesta esplicita dell'utente, ha eseguito una sostituzione completa del sistema HACCP. Analizzando i file ZIP forniti, l'agente ha implementato un nuovo e più complesso sistema HACCP V2, che include moduli per frigoriferi, congelatori, sanificazioni, disinfestazioni, lotti di produzione, manuale di autocontrollo e altro. Ha creato i relativi endpoint backend, le pagine frontend, e ha aggiornato il menu di navigazione, eliminando il vecchio sistema.

**Last working item**:
- **Last item agent was working**: L'agente stava finalizzando l'implementazione del nuovo sistema HACCP V2. Dopo un primo tentativo incompleto, l'utente ha richiesto di implementare *tutti* i moduli presenti nei file ZIP forniti. L'agente ha quindi implementato la struttura completa, ma si è accorto che il modulo per i **Lotti di Produzione** () era ancora incompleto. Manca la logica cruciale per leggere le fatture XML, estrarre le informazioni sui lotti e popolare il database.
- **Status**: IN PROGRESS
- **Agent Testing Done**: Y
- **Which testing method agent to use?**: backend testing agent. L'agente dovrà creare la logica per leggere e parsare i file XML delle fatture, per poi popolare la collection . Un test backend è necessario per triggerare questa funzione e verificare che i dati vengano scritti correttamente nel database.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
Nessun problema bloccante al momento. Il lavoro è focalizzato sul completamento di una task.

**In progress Task List**:
- **Task 1: Completamento del modulo Lotti di Produzione (HACCP V2) (P0)**
    - **Where to resume**: Il file  deve essere completato. L'agente deve implementare una funzione che legga le fatture elettroniche in formato XML (probabilmente dalla cartella ), ne estragga i dati relativi ai lotti dei prodotti e popoli la collection  nel database per garantire la tracciabilità.
    - **What will be achieved with this?**: Completerà l'implementazione del sistema HACCP V2, una richiesta ad alta priorità dell'utente, rendendo automatica la tracciabilità alimentare.
    - **Status**: IN PROGRESS
    - **Should Test frontend/backend/both after fix?**: backend
    - **Blocked on something**: No.

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **(P1) UI Compatta Globale**: Ridurre dimensioni e spaziature in **tutte** le pagine dell'applicazione per renderla più densa di informazioni e minimizzare lo scrolling.
    *   **(P1) Integrazione Logo Aziendale**: Inserire il logo aziendale (già scaricato) in tutte le pagine dell'app e nel PDF del carnet assegni.
    *   **(P1) Filtro Annuale Globale**: Implementare un filtro per anno che si applichi a tutte le sezioni dell'app (es. statistiche, fatturato), escluse le giacenze di magazzino.
    *   **(P1) Rielaborazione Cespiti**: Permettere modifica/cancellazione e preparare il modulo per leggere i dati da un bilancio in PDF (che l'utente fornirà in seguito).
    *   **(P1) Completamento modulo Cedolini**: Aggiungere UI per paga oraria, gestione maggiorazione domenicale e calcolo malattia.
    *   **(P1) Rielaborazione Archivio Bonifici**: Migliorare l'associazione con i cedolini, aggiungere note e download ZIP per anno.
*   **Future Tasks**:
    *   **(P2) Ottimizzazione Riconciliazione Batch**: Risolvere il problema del timeout dell'endpoint e aggiungere un pulsante dedicato nell'UI.
    *   **(P2) Keep-Alive Server**: Implementare un meccanismo per evitare che l'applicazione vada in standby.
    *   **(P2) Semplificazione Previsioni Acquisti**: Aggregare i prodotti per tipologia.
    *   **(P2) Miglioramento Ricerca Prodotti**: Affinare la logica di categorizzazione.

**Completed work in this session**
- **Correzione Bug Critici (P0)**:
  - Risolto il bug di visualizzazione in  aggiungendo il campo  nel backend.
  - Corretto l'URL per l'esportazione Excel e rimosso il pulsante Esporta JSON dalla pagina Admin.
  - Ripristinato l'accesso alla documentazione API () configurando il proxy di Vite.
  - Corretta la logica di paginazione nella pagina  per utilizzare il  restituito dall'API.
  - Creato l'endpoint mancante  per visualizzare le statistiche nella pagina Admin.
- **Implementazione Gestione Acconti (P0)**:
  - Creati endpoint backend per aggiungere, visualizzare ed eliminare acconti (TFR, ferie, prestiti) per i dipendenti.
  - Aggiunto un nuovo tab Acconti nella modale dei dettagli del dipendente per gestire queste operazioni.
- **Sostituzione Completa del Sistema HACCP (HACCP V2)**:
  - Rimpiazzato l'intero modulo HACCP obsoleto con la nuova versione fornita dall'utente tramite file ZIP.
  - Implementati backend e frontend per tutti i nuovi moduli: Temperature Positive/Negative, Sanificazioni, Disinfestazione, Chiusure, Anomalie, Lotti, Manuale HACCP.
  - Rimosse le vecchie rotte backend e i vecchi file frontend, aggiornando la navigazione per puntare al nuovo sistema ().

**Code Architecture**


**Key Technical Concepts**
- **Sostituzione di un Modulo Complesso**: L'agente ha eseguito con successo la sostituzione completa di un'intera sezione dell'applicazione (HACCP), adattando il codice fornito dall'utente all'architettura esistente (es. uso del singleton  invece di connessioni DB dirette).
- **Refactoring del Backend**: Sono state rimosse le vecchie rotte API e registrata una suite di nuovi router modulari per il sistema HACCP V2 in .
- **Debugging Multi-livello**: L'agente ha diagnosticato e risolto bug che spaziavano dal backend (logica API mancante) al frontend (URL errati, gestione stato) e alla configurazione dell'ambiente (proxy Vite per ).

**key DB schema**
- **dipendenti**: Modificata per includere un campo  (array di oggetti) per tracciare anticipi e prestiti.
- **Nuove collection per HACCP V2**: Sono state create numerose nuove collection per supportare il nuovo sistema, tra cui , , , , , ecc.

**All files of reference**
-   : Directory contenente tutta la nuova logica backend per HACCP.
-    e : Nuovi file per le pagine e i componenti di HACCP V2.
-   : Aggiornato per riflettere i bug fix e l'implementazione del nuovo sistema.
-   , : File principali di routing, modificati pesantemente.

**Critical Info for New Agent**
-   **Priorità Assoluta**: Completare il modulo  del sistema HACCP V2. Questa è l'ultima parte mancante della richiesta P0 dell'utente sulla sostituzione di HACCP. La logica deve parsare le fatture XML per popolare i lotti.
-   **Seguire la To-Do List**: Una volta completato HACCP, il prossimo passo è presentare all'utente un piano basato sulla lista di Upcoming Tasks (P1), partendo dalla UI compatta globale e dall'integrazione del logo.
-   **Fonte di Verità**: La lunga lista di richieste nel messaggio 276 dell'handoff originale è ancora la roadmap principale per le funzionalità future. I bug P0 sono stati risolti, ma le feature P1 e P2 sono tutte in attesa.

**documents and test reports created in this job**
-    (aggiornato)

**Last 10 User Messages and any pending HUMAN messages**
-   **Msg 349:** L'utente critica il primo tentativo incompleto di implementazione di HACCP V2, sottolineando i moduli mancanti (sanificazione, lotti, manuale) e chiede di eliminare tutto il vecchio sistema e implementare perfettamente quello nuovo dai file ZIP.
-   **Msg 453 (latest):** Continua - Approvazione da parte dell'utente a procedere dopo che l'agente ha riepilogato il completamento (quasi totale) dell'implementazione di HACCP V2.
-   **Msg 454 & 457:** Messaggi dell'agente che inizia ad analizzare  e si accorge che è incompleto.

**Project Health Check:**
*   **Broken**: La funzionalità di tracciabilità dei lotti di produzione nel nuovo sistema HACCP V2 non è ancora implementata.
*   **Mocked**: Nessuno.

**3rd Party Integrations**
*   **Google/Gmail (IMAP)**: Per scaricare email e allegati (usato in altre parti dell'app).
*   **pdfplumber**: Per estrarre dati da file PDF.
*   **pandas/openpyxl**: Per leggere e scrivere file Excel.
*   **beautifulsoup4**: Per parsare il contenuto HTML delle email.
*   **xml.etree.ElementTree**: Sarà necessario per parsare le fatture XML per il modulo lotti.

**Testing status**
-   **Testing agent used after significant changes**: NO (non ancora per HACCP V2 completo)
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno
-   **Known regressions**: Nessuna regressione nota introdotta in questa sessione.

**Credentials to test flow:**
-   **Email User**: 
-   **Email App Password**:  (disponibile in ).

**What agent forgot to execute**
-   Inizialmente, l'agente ha eseguito un'implementazione parziale del nuovo sistema HACCP V2, omettendo diversi moduli chiave forniti dall'utente nei file ZIP. Questo ha richiesto un intervento da parte dell'utente per correggere la rotta. L'agente ha poi proceduto a una reimplementazione più completa, che è ancora in corso.</analysis>
