<analysis>**original_problem_statement:**
L'utente ha inizialmente richiesto di unificare le pagine di riconciliazione e gestione fornitori, per poi passare a una richiesta più ampia: sviluppare un sistema intelligente di estrazione dati per fatture (PDF), F24 e buste paga, con classificazione e collegamento automatico a fornitori e piano dei conti. La priorità si è poi spostata sulla gestione perfetta degli F24 e sull'automazione completa dell'acquisizione dei documenti, in particolare delle fatture notificate via email da Aruba (che non contengono allegati XML ma solo dati nel corpo del testo). L'utente ha espresso estrema frustrazione per i ripetuti errori dell'agente, culminando nella minaccia di abbandonare il progetto.

**User's preferred language**: Italiano

**what currently exists?**
Un'applicazione full-stack (FastAPI + React) con un sistema di estrazione dati e automazione avanzato.
- **Parser AI Universale**: Un servizio () basato su Claude Vision estrae dati da PDF di fatture, F24 e buste paga.
- **Automazione su Upload e Email**: Il parsing AI è attivo sia per i file caricati direttamente (tramite i nuovi endpoint in ) sia per i documenti scaricati da email.
- **Automazione Fatture Aruba (CRITICA)**: È stato implementato un flusso di lavoro completo () che:
    1.  Legge il corpo delle email di notifica di Aruba per estrarre i dati della fattura.
    2.  Cerca il fornitore nel dizionario; se non esiste, lo crea automaticamente con metodo di pagamento predefinito banca.
    3.  Rispetta il metodo di pagamento del fornitore: se è banca o simile, la fattura viene registrata in  in attesa di riconciliazione.
    4.  Crea una fattura provvisoria in attesa dell'arrivo del file XML per l'associazione finale.
- **Sistema di Chat Intelligente**: Un'API () permette di interrogare i dati aziendali (fatture, bilancio, F24, ecc.) in linguaggio naturale.
- **Dati F24 Unificati e Deduplicati**: La collezione  è stata creata, popolata e ripulita da 250 duplicati.
- **Classificazione Fatture al 100%**: Tutte le 3753 fatture nel sistema sono state classificate.
- **UI Correzione AI**: È stata creata la pagina () per la futura implementazione della correzione manuale dei dati estratti dall'AI.

**Last working item**:
-   **Last item agent was working**: Correzione critica della logica di automazione delle fatture Aruba. L'agente ha risolto un bug per cui le fatture venivano erroneamente classificate come probabile cassa invece di rispettare il metodo di pagamento predefinito del fornitore (banca). È stata anche aggiunta la creazione automatica del fornitore se non presente nel dizionario.
-   **Status**: USER VERIFICATION PENDING
-   **Agent Testing Done**: Y
-   **Which testing method agent to use?**: backend testing agent. L'agente deve verificare l'intero flusso di  per confermare che la logica corretta sia applicata in modo consistente, specialmente per i fornitori con metodo di pagamento banca e per i fornitori non esistenti.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: Crisi di Fiducia dell'Utente (P0)**
    -   **Description**: L'utente è estremamente frustrato, ha definito l'agente inutile, ha minacciato di interrompere il progetto e di migrare su un'altra piattaforma. Questa è la priorità assoluta.
    -   **Attempted fixes**: L'agente ha corretto l'errore logico che ha scatenato la frustrazione dell'utente.
    -   **Next debug checklist**:
        1.  Alla prossima interazione, riconoscere la frustrazione dell'utente in modo conciso e professionale.
        2.  Proporre un piano focalizzato esclusivamente sulla stabilizzazione e verifica delle funzionalità già costruite, senza introdurre nulla di nuovo.
        3.  Dimostrare la correttezza e la robustezza del sistema, in particolare l'automazione Aruba, attraverso test chiari.
    -   **Why fix this issue and what will be achieved with the fix?**: Riguadagnare la fiducia dell'utente è essenziale per la sopravvivenza del progetto.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: No

**In progress Task List**:
Nessuno.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **(P2) Finalizzare UI per Correzione Manuale Dati AI**: Implementare la logica backend e frontend per la pagina  per permettere la modifica dei dati estratti.
    -   **(P3) Refactoring Strutturale Backend**: Suddividere i router monolitici (, ) come richiesto dall'utente per migliorare la manutenibilità.

-   **Future Tasks**:
    -   **(P2) Suggerimento Automatico di Regole**: Durante la classificazione manuale di una fattura, suggerire la creazione di una nuova regola per la Learning Machine.
    -   **(P3) Sistema di Alert**: Creare un endpoint per inviare alert (via Dashboard o Telegram) per le operazioni da verificare o le scadenze.

**Completed work in this session**
-   **Automazione Fatture Aruba (DONE & CORRECTED)**: Implementata e corretta la logica per leggere le email di Aruba, creare fornitori, rispettare i metodi di pagamento e generare fatture provvisorie.
-   **Deduplicazione F24 (DONE)**: Completata la pulizia della collezione .
-   **Automazione Upload Diretto (DONE)**: Implementato il parsing AI per F24, cedolini e fatture PDF caricati direttamente.
-   **Sistema di Chat Intelligente (DONE)**: Creato servizio e API per interrogare i dati aziendali con linguaggio naturale.
-   **Classificazione Fatture al 100% (DONE)**: Raggiunta la classificazione completa di tutte le fatture.
-   **Creazione UI Correzione AI (DONE - Scaffolding)**: Creata la pagina .
-   **Refactoring Leggero (DONE)**: Rimossa una pagina inutilizzata e corretti errori di linting.

**Earlier issues found/mentioned but not fixed**
Nessuno.

**Known issue recurrence from previous fork**
Nessuno.

**Code Architecture**


**Key Technical Concepts**
-   **Email Body Parsing**: Capacità di estrarre dati strutturati direttamente dal corpo HTML delle email, non solo dagli allegati.
-   **Provisional Data Records**: Utilizzo di fatture provvisorie come segnaposto in attesa del documento XML completo, permettendo una registrazione contabile immediata.
-   **Rule-Based Automation**: Logica che privilegia le regole pre-impostate (metodo di pagamento del fornitore) rispetto a tentativi di inferenza (riconciliazione bancaria).
-   **Automatic Entity Creation**: Il sistema crea automaticamente nuovi fornitori nel database quando vengono rilevati per la prima volta.

**key DB schema**
-   ** (NUOVA)**: .
-   ****: MODIFICATO per includere e utilizzare il campo .

**All files of reference**
-   
-   
-   
-   
-   
-   

**Areas that need refactoring**:
-   I file router  e  sono eccessivamente grandi e andrebbero suddivisi.

**key api endpoints**
-    |  | 
-   
-   
-   

**Critical Info for New Agent**
-   **LA PRIORITÀ ASSOLUTA È RECUPERARE LA FIDUCIA DELL'UTENTE.** L'utente è estremamente scontento e ha minacciato di chiudere il progetto. Il prossimo passo deve essere un'azione cauta, mirata a dimostrare stabilità e competenza. Non iniziare nuove funzionalità.
-   **La logica per le fatture Aruba è critica e sensibile.** È stata implementata e corretta più volte. Si trova in . La regola chiave è che il metodo di pagamento predefinito del fornitore ha sempre la precedenza. Non modificare questa logica senza una chiara comprensione delle interazioni passate.
-   L'utente ha un'ottima memoria e noterà qualsiasi incoerenza o promessa non mantenuta. Sii meticoloso e fai riferimento alle decisioni passate.

**documents and test reports created in this job**
-    (aggiornato significativamente)
-   
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **Non sei capace... fermiamoci qua**: Messaggio finale di estrema frustrazione, minacciando di abbandonare il progetto.
2.  **La ragione si dà ai fissi o agli stupidi**: Reazione di rabbia alla proposta dell'agente di aggiungere un fornitore manualmente, ricordandogli che l'automazione era già stata richiesta.
3.  **Devi sempre guardare il metodo di pagamento del fornitore!**: Correzione furiosa della logica dell'agente, che aveva erroneamente classificato una fattura Amazon come cassa.
4.  **Dammi un alert per le operazioni da completare**: Richiesta di un riepilogo delle azioni manuali necessarie.
5.  **Spiegami come funziona la pratica...**: Richiesta di spiegazione del flusso completo per le fatture Aruba.
6.  **Leggi bene... la regola già è scritta**: Indicazione precisa all'agente di cercare una logica preesistente per la gestione delle email Aruba.
7.  **Controlla di nuovo la posta**: Richiesta di verificare la presenza di una specifica fattura Aruba.
8.  **Procedi**: Approvazione del piano dell'agente.
9.  **Sì continua con p1 e poi P2 poi fai un refactoring**: Approvazione del piano d'azione proposto dall'agente.
10. **Mi devi garantire che vengono processati...**: Richiesta di conferma che l'automazione copra tutti i tipi di documenti e che la chat possa interrogare tutti i dati.

**Project Health Check:**
-   **Broken**: La fiducia dell'utente è compromessa. Il rischio di abbandono del progetto è molto alto.
-   **Mocked**: Nessuno.

**3rd Party Integrations**
-   **Claude Vision** (via ): Utilizzato per l'estrazione dati dai PDF. Usa .

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno
-   **Known regressions**: La logica di classificazione del pagamento (cassa/banca) per le fatture Aruba è stata una regressione introdotta e poi corretta durante la sessione.

**Credentials to test flow:**
Nessuna credenziale speciale richiesta.

**What agent forgot to execute**
-   L'agente ha dimenticato una regola fondamentale precedentemente stabilita (rispettare il metodo di pagamento del fornitore), causando un errore critico che ha distrutto la fiducia dell'utente.
-   Inizialmente, l'agente non si è reso conto dell'esistenza di uno script () per l'analisi delle email di Aruba, dimostrando una mancanza di consapevolezza del codice esistente.</analysis>
