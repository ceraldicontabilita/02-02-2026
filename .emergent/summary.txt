<analysis>**original_problem_statement:**
L'utente ha inizialmente segnalato un bug nella pagina  che impediva la modifica del metodo di pagamento e ha richiesto di ingrandire i relativi pulsanti. Successivamente, ha sollevato un problema critico di dati mancanti nella sezione Noleggio Auto (verbali, riparazioni, bolli), richiedendo una soluzione per garantire la persistenza e la sicurezza dei dati.

Le richieste si sono evolute in un complesso sistema di gestione del ciclo passivo e dei documenti, che include:
1.  **Correzione Formati**: Standardizzare l'intera applicazione per utilizzare il formato data  e valuta , applicando la correzione retroattivamente dal 2018.
2.  **Gestione Verbali Completa**: Riscansionare tutte le fatture dal 2018 per estrarre e associare ogni costo (verbali, riparazioni, bolli, extra) ai veicoli.
3.  **Riconciliazione Automatica da Email**: Per ogni verbale trovato in una fattura XML, il sistema deve:
    *   Cercare automaticamente nella casella di posta dell'utente (Gmail).
    *   Scaricare il PDF del verbale corrispondente.
    *   Associare il PDF a tutte le entità collegate: verbale, auto, dipendente, contratto, fattura e pagamento bancario.
4.  **Operazioni Sospese**: Creare una sezione per i verbali trovati nelle fatture ma non ancora riconciliati con un estratto conto (bancario o carta di credito). Una volta trovato il pagamento, il verbale deve essere rimosso da questa lista.
5.  **Indicizzazione e Ricerca Globale**: Creare un indice di **tutti i documenti** presenti nel gestionale (fatture, verbali, contratti, ecc.). Il sistema deve scansionare costantemente e interamente la casella di posta, cercare corrispondenze con l'indice e associare automaticamente i file trovati (PDF, etc.) ai documenti pertinenti, archiviandoli in modo sicuro.
6.  **Classificazione Verbali Senza Fattura**: Per i verbali trovati via email ma non ancora presenti in una fattura, il sistema deve leggerne il contenuto (es. targa), classificarli come in attesa di fattura (se la targa è aziendale) o da verificare (se la targa è sconosciuta/privata) e gestirli in sezioni apposite.

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha risolto il bug sulla pagina  e ingrandito i pulsanti come richiesto. Ha identificato che i dati del noleggio mancavano perché venivano calcolati dinamicamente anziché essere persistiti; ha quindi creato un sistema di persistenza per i costi del noleggio () e ha eseguito una migrazione per popolarlo con i dati storici.

È stato implementato un sistema avanzato per la gestione dei verbali:
-   Scansione delle fatture per estrarre i dati dei verbali e salvarli nella collection .
-   Creazione di una pagina di dettaglio () per visualizzare le informazioni di un singolo verbale.
-   Implementazione della funzionalità per scaricare i PDF dei verbali dalla posta Gmail.
-   Creazione di un servizio generico () per indicizzare i documenti e riconciliarli con le email.
-   Refactoring dell'interfaccia della pagina  per renderla più compatta.

L'agente ha scoperto che i dati dei verbali sono frammentati tra diverse collection e anni fiscali (2023, 2024, 2025), il che spiegava perché l'utente non visualizzava tutti i dati attesi. Infine, ha iniziato a implementare il sistema di classificazione per i verbali trovati via email che non hanno una fattura corrispondente.

**Last working item**:
-   **Last item agent was working**: L'agente stava implementando il sistema di classificazione per i verbali scaricati dalla posta ma non ancora associati a una fattura. Ha creato il servizio  ma si è bloccato a causa di continui errori di connessione al database () e altri problemi di stabilità del backend che gli hanno impedito di eseguire gli script di classificazione.
-   **Status**: BLOCKED
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: backend testing agent (per validare gli script di classificazione e le operazioni sul DB) e successivamente frontend testing agent (per la nuova UI di visualizzazione).
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Risolvere l'instabilità del backend e i problemi di connessione al database.**
-   **Issue 2: (P0) Completare il sistema di classificazione dei verbali.**
-   **Issue 3: (P1) Implementare l'interfaccia utente per la gestione dei verbali classificati.**
-   **Issue 4: (P1) Rendere la riconciliazione email un processo in background.**
-   **Issue 5: (P2) Standardizzare globalmente i formati di data e valuta.**
-   **Issue 6: (P2) Testare la logica di sovrascrittura dei corrispettivi tramite XML.**
-   **Issue 7: (P2) Eseguire il refactoring dei router backend (, ).**

**Issues Detail**:
-   **Issue 1: Risolvere l'instabilità del backend e i problemi di connessione al database**
    -   **Attempted fixes**: Riavvio del backend, tentativi di connessione con .
    -   **Next debug checklist**:
        1.  Verificare  e  per assicurarsi che  e  () siano corretti.
        2.  Controllare i log di supervisor () per errori all'avvio.
        3.  Assicurarsi che il client Pymongo in  includa le opzioni TLS/SSL corrette (es. ).
        4.  Isolare il problema testando la connessione al DB con uno script Python semplice dalla shell, usando le stesse credenziali.
    -   **Why fix this issue and what will be achieved with the fix?**: È un bloccante critico per qualsiasi sviluppo sul backend, inclusa la funzionalità di classificazione dei verbali.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: No.

-   **Issue 2: Completare il sistema di classificazione dei verbali**
    -   **Attempted fixes**: Creato il servizio  e gli endpoint API. I tentativi di esecuzione sono falliti a causa di timeout e problemi di connessione al DB.
    -   **Next debug checklist**:
        1.  Una volta stabilizzata la connessione al DB, rendere la logica di classificazione in  più efficiente.
        2.  Il processo deve leggere i verbali dalla collection  (quelli scaricati da email), estrarre la targa, confrontarla con la lista di veicoli aziendali e inserirli nelle collection corrette ( o ).
        3.  Creare un endpoint API affidabile per avviare questa classificazione in modo massivo.
    -   **Why fix this issue and what will be achieved with the fix?**: È una richiesta esplicita dell'utente per gestire la discrepanza tra i documenti ricevuti via email e quelli presenti nelle fatture.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: Issue 1: Risolvere l'instabilità del backend e i problemi di connessione al database.

**In progress Task List**:
-   **Task 1: Implementazione della classificazione dei verbali**
    -   **Where to resume**: Nei file  e . È necessario prima risolvere i problemi di connessione al DB, poi eseguire la logica di classificazione.
    -   **What will be achieved with this?**: I verbali scaricati dalla posta verranno smistati automaticamente in In attesa di fattura o Da verificare, risolvendo il problema dei documenti non collegati.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on something**: Stabilità del backend e connessione al database.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P0) **UI per Verbali Classificati**: Creare una nuova pagina o una sezione in  per visualizzare e gestire le liste Verbali in attesa di fattura e Verbali da verificare.
    -   (P1) **Riconciliazione Email in Background**: Trasformare la scansione completa della posta in un processo asincrono e creare un'interfaccia per monitorarne lo stato.
    -   (P2) **Correzione Globale Formati**: Scansionare l'intera codebase (frontend e backend) per applicare in modo consistente i formati  e .
-   **Future Tasks**:
    -   (P2) Testare la logica di sovrascrittura dei corrispettivi tramite XML.
    -   (P2) Eseguire il refactoring dei router backend.
    -   (P2) Implementare OCR sui PDF dei verbali per estrarre automaticamente targa, data e importo.
    -   (P3) Rispondere alla vecchia domanda dell'utente su come viene calcolata la data di scadenza delle fatture.

**Completed work in this session**
-   Risolto il bug che impediva il cambio del metodo di pagamento in .
-   Ingranditi i pulsanti di azione nella stessa pagina.
-   Implementato un sistema di persistenza per i costi del noleggio auto, risolvendo il problema dei dati mancanti, ed eseguita una migrazione per popolare i dati storici.
-   Creato un sistema completo per la gestione dei verbali, inclusa la scansione delle fatture, una pagina di dettaglio (), e il download dei PDF da Gmail.
-   Refactoring dell'interfaccia di  per renderla più compatta.
-   Avviata la creazione di un servizio generico per la riconciliazione tra email e documenti del gestionale.
-   Aggiornato il file  con le nuove specifiche.

**Earlier issues found/mentioned but not fixed**
-   La domanda dell'utente su come viene calcolata la data di scadenza delle fatture.
-   Il refactoring dei router backend (, ).
-   Il test completo della logica di sovrascrittura dei corrispettivi XML.

**Code Architecture**


**Key Technical Concepts**
-   **Persistenza vs. Calcolo Dinamico**: Il problema principale dei dati mancanti era che venivano calcolati dinamicamente. La soluzione è stata creare collection dedicate (, ) per rendere i dati stabili e affidabili.
-   **Riconciliazione Multi-sorgente**: I verbali provengono da tre fonti (email, fatture XML, estratti conto). Il sistema sta evolvendo per collegare queste fonti, gestendo stati come In attesa di fattura e Sospeso.
-   **Instabilità della Connessione al Database**: I ripetuti errori  indicano un problema nella configurazione del client Pymongo o nella gestione delle connessioni TLS/SSL nell'ambiente cloud.

**key DB schema**
-   **invoices**: Fatture ricevute.
-   **costi_noleggio**: **NUOVA**. Persiste i costi specifici (verbali, bolli, riparazioni) estratti dalle fatture e collegati a un veicolo.
-   **verbali_noleggio**: Collection originale per i verbali scaricati da email, spesso con dati incompleti.
-   **verbali_noleggio_completi**: **NUOVA**. Collection master per i verbali, popolata tramite la scansione delle fatture.
-   **verbali_attesa_fattura**: **PIANIFICATA**. Per i verbali da email con targa aziendale ma senza fattura.
-   **verbali_da_verificare**: **PIANIFICATA**. Per i verbali da email con targa sconosciuta.
-   **document_index**: **NUOVA**. Indice generico per tutti i documenti, usato per la riconciliazione rapida con le email.

**All files of reference**
-    (Router centrale per la logica dei verbali)
-    (Servizio per l'attività attualmente bloccata)
-    (Potenziale fonte dei problemi di connessione al DB)
-    (Credenziali del DB)
-    (UI principale per i dati del noleggio)
-    (Requisiti di prodotto aggiornati)

**Critical Info for New Agent**
-   **L'instabilità del database è il bloccante principale.** Prima di procedere, devi risolvere l'errore . Controlla la configurazione del client Pymongo in  (il nome del DB corretto è ) e valuta l'aggiunta di opzioni TLS come .
-   **Il problema principale dell'utente è la frammentazione dei dati.** I documenti esistono in più posti (email, fatture, banca). Il tuo obiettivo è unificarli. Il passo successivo è completare il sistema di classificazione per i verbali che esistono solo nelle email.
-   **L'utente si aspetta un sistema proattivo.** L'obiettivo non è solo rispondere alle richieste, ma costruire sistemi automatici (scansione email, classificazione) che mantengano i dati dell'applicazione costantemente sincronizzati.
-   **Quando l'utente segnala dati mancanti, controlla l'anno.** I dati esistono ma sono distribuiti tra il 2023, 2024 e 2025. L'utente potrebbe guardare l'anno sbagliato.
-   **La riconciliazione email generica è una funzionalità strategica.** L'utente vuole un sistema che indicizzi tutti i documenti e scansioni l'intera casella di posta per trovare e collegare file pertinenti. Questo richiederà probabilmente processi in background.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Chiede di procedere con le correzioni e le implementazioni.
2.  **User**: Chiede perché l'agente è fermo e di preparare un riassunto per il fork.
3.  **User**: Approva il piano per la classificazione dei verbali e chiede di procedere.
4.  **User**: Specifica la logica per i verbali senza fattura: registrarli, classificarli (aziendali vs. privati) e attendere la fattura.
5.  **User**: Segnala di non vedere tutti i verbali che si aspetta nella pagina del noleggio.
6.  **User**: Dettaglia i requisiti per un sistema completo di gestione verbali: riscansione dal 2018, download automatico dei PDF da email, collegamento a tutte le entità e una sezione operazioni sospese.
7.  **User**: Esprime frustrazione per i dati mancanti nel noleggio, chiede misure di sicurezza e l'applicazione globale dei formati italiani per data e valuta.
8.  **User**: Conferma la logica di importazione delle fatture da email.
9.  **User**: Chiede da dove vengono recuperate le fatture.
10. **User**: Chiede una spiegazione della logica della pagina .

**Project Health Check:**
-   **Broken**: Il backend è instabile a causa di continui timeout di connessione al database, bloccando di fatto lo sviluppo.
-   **Mocked**: L'OCR per la lettura del contenuto dei PDF non è implementato. Il sistema di riconciliazione email generico è progettato ma non funzionante a causa dei timeout.

**3rd Party Integrations**
-   Gmail (IMAP)
-   MongoDB Atlas

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: No
-   **Known regressions**: None

**What agent forgot to execute**
-   Non ha ancora eseguito una correzione globale e sistematica dei formati di data e valuta in tutta l'applicazione.
-   Non ha risposto alla vecchia domanda dell'utente su come viene calcolata la data di scadenza delle fatture.
-   Non ha completato il test della logica di sovrascrittura dei corrispettivi XML né il refactoring dei router backend.</analysis>
