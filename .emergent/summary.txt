<analysis>**original_problem_statement:**
L'utente ha espresso una serie di richieste urgenti e complesse per evolvere il sistema gestionale, con un focus sul ciclo passivo, la prima nota e l'esperienza utente.

**Requisiti Principali:**
1.  **Ciclo Passivo Automatizzato da Email**: Quando il sistema scarica email, deve estrarre Fornitore, Numero Fattura, Importo e Data. Questi dati devono popolare  come record **provvisorio**.
2.  **Scelta Metodo di Pagamento**: Dal record provvisorio in , l'utente deve poter scegliere Cassa o Banca. Questa scelta deve creare automaticamente la registrazione corrispondente in  o .
3.  **Sovrascrittura con XML**: Il dato letto da email è provvisorio. Quando viene caricato il file XML della fattura, questo deve **sovrascrivere** il record provvisorio (match su P.IVA + Numero Fattura), non creare un duplicato.
4.  **Logica Corrispettivi e POS**: Anche le registrazioni manuali di Corrispettivi e POS in  sono **provvisorie**. Quando viene caricato l'XML dei corrispettivi, deve **sovrascrivere** i dati manuali di Corrispettivi e POS per la stessa **DATA**.
5.  **Refactoring UI **:
    *   Unificare i tre campi di input del POS in un unico campo.
    *   Riscrivere la pagina  con la stessa grafica della pagina  (UI compatta, colori specifici).
    *   Rendere più compatta la card Versamenti, usando un menu a tendina se necessario.
6.  **Spostamento Movimenti**:
    *   In  e , deve esserci la possibilità di spostare un movimento da un registro all'altro (es. da Cassa a Banca).
    *   Questa operazione deve aggiornare anche lo stato della fattura collegata in .
    *   L'azione di spostamento deve essere unificata con la selezione del metodo di pagamento (se un movimento è in Cassa e l'utente clicca Banca, deve spostarsi automaticamente).

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha implementato con successo gran parte delle richieste urgenti dell'utente.
- Sono stati rimossi tutti i .
- La pagina di Dettaglio Fattura è stata eliminata.
- Sono stati creati gli endpoint e i componenti UI per l'aggiornamento massivo dei metodi di pagamento.
- **Logica Dati Provvisori**: Il backend è stato aggiornato per trattare i dati manuali di Corrispettivi/POS come provvisori, che vengono sovrascritti dall'upload dell'XML corrispondente (match per data). Anche l'import delle fatture XML è stato modificato per rispettare le scelte manuali dell'utente sul metodo di pagamento.
- **UI Prima Nota**: La pagina  è stata parzialmente modificata: i campi POS sono stati unificati in uno solo e sono stati aggiunti i pulsanti per spostare i movimenti tra Cassa e Banca. Il backend per questa funzionalità () è stato creato e testato con successo.
- L'agente ha identificato che la richiesta dell'utente di modificare Prima Nota Unificata si riferisce in realtà alla pagina , poiché il file  non è utilizzato.

**Last working item**:
-   **Last item agent was working**: L'agente stava lavorando sulla richiesta dell'utente di testare la nuova logica dei corrispettivi e di uniformare l'UI della pagina  allo stile della pagina . Aveva iniziato il test creando record manuali di corrispettivi/POS e stava investigando come procedere con il refactoring dell'UI dopo aver capito che il file corretto da modificare è  e non .
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N (Il test della logica di sovrascrittura XML è iniziato ma non completato).
-   **Which testing method agent to use?**: both (Backend per la logica di sovrascrittura XML; Frontend per il restyling UI).
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Testare la logica di sovrascrittura dei dati provvisori.**
-   **Issue 2: (P0) Completare il restyling della pagina .**
-   **Issue 3: (P1) Implementare il parsing delle fatture dalle email.**
-   **Issue 4: (P1) Completare il refactoring dei router backend (, ).**
-   **Issue 5: (P2) Rispondere alla vecchia domanda dell'utente sull'origine della data di scadenza delle fatture.**

**Issues Detail**:
-   **Issue 1: Testare la logica di sovrascrittura dei dati provvisori**
    -   **Attempted fixes**: L'agente ha creato i record manuali (provvisori) per Corrispettivi e POS tramite API.
    -   **Next debug checklist**:
        1.  Creare un file  di esempio che contenga dati per la stessa data dei record manuali.
        2.  Chiamare l'endpoint  con il file di test.
        3.  Verificare nel database (collection ) che i record con  e  per quella data siano stati rimossi.
        4.  Verificare che siano stati creati i nuovi record con .
    -   **Why fix this issue and what will be achieved with the fix?**: È una logica di business critica richiesta dall'utente per garantire che i dati finali provengano solo da fonti ufficiali (XML).
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: No.

-   **Issue 2: Completare il restyling della pagina **
    -   **Next debug checklist**:
        1.  Analizzare lo stile di  (header, card, colori).
        2.  Applicare lo stesso stile (header con gradiente blu, ) a .
        3.  Identificare la card Versamenti e le altre card principali.
        4.  Ridurle in dimensioni per renderle più compatte, implementando un menu a tendina se necessario per contenere le azioni.
        5.  Verificare il risultato con uno screenshot.
    -   **Why fix this issue and what will be achieved with the fix?**: Soddisfa una richiesta esplicita dell'utente di uniformare l'UI e renderla più compatta e moderna.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y (L'utente richiede spesso UI compatte).
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: No.

**In progress Task List**:
-   **Task 1: Test della logica di sovrascrittura**
    -   **Where to resume**: Eseguire l'upload di un file XML di test per verificare che i dati manuali vengano sostituiti.
    -   **What will be achieved with this?**: Conferma che la regola XML è la fonte di verità funziona come richiesto.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on something**: No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P1) **Implementare il parsing delle fatture dalle email**: Sviluppare la logica per leggere le email, estrarre i dati delle fatture e creare record provvisori in .
    -   (P1) **Completare il refactoring dei router backend**: Spostare la logica di business da  e  ai rispettivi moduli di servizio.
-   **Future Tasks**:
    -   (P2) **Rispondere alla domanda utente**: Analizzare il codice per spiegare da dove viene calcolata la data di scadenza delle fatture.
    -   (P2) **Aggiungere Test Unitari**: Creare test per i moduli di servizio del backend.

**Completed work in this session**
-   **Rimozione **: Tutti i dialoghi di conferma sono stati eliminati dall'applicazione.
-   **Funzionalità Sposta Movimento in Prima Nota**:
    -   Aggiunti pulsanti all'interfaccia di  per spostare movimenti tra Cassa e Banca.
    -   Creato e testato l'endpoint backend .
-   **Unificazione Input POS**: I tre campi di input per il POS in  sono stati unificati in un singolo campo.
-   **Logica Dati Provvisori (Backend)**:
    -   Modificato l'import dei corrispettivi XML per sovrascrivere i dati manuali basandosi sulla data.
    -   Modificato l'import delle fatture XML per rispettare il metodo di pagamento scelto manualmente dall'utente.

**Code Architecture**


**Key Technical Concepts**
-   **Dati Provvisori vs. Definitivi**: Concetto chiave in cui i dati inseriti manualmente o da email sono temporanei () e vengono sempre sovrascritti dalla fonte di dati ufficiale (XML). La chiave di match per la sovrascrittura varia in base al contesto (Data per i corrispettivi, P.IVA+Numero per le fatture).
-   **Refactoring UI Guidato da Esempio**: Utilizzo di una pagina esistente () come template di stile per uniformare l'aspetto di altre sezioni dell'applicazione.

**key DB schema**
-   **prima_nota_cassa / prima_nota_banca**: Contengono i movimenti contabili. Ora includono i campi  e  per distinguere i dati temporanei.
-   **invoices**: Contiene le fatture. È stato aggiunto il campo  per dare priorità alla scelta dell'utente rispetto al default del fornitore. Potrebbe necessitare di .
-   **corrispettivi**: Contiene i dati degli XML dei corrispettivi. La logica di import ora si basa sulla  per sovrascrivere i record manuali.

**All files of reference**
-    (Pagina da modificare e testare)
-    (Template per lo stile)
-    (Logica di import da testare)
-    (Contiene l'endpoint di spostamento)
-    (Contiene la logica di pagamento/spostamento da replicare)
-    (Per verificare la navigazione)

**Critical Info for New Agent**
-   **La regola d'oro: l'XML è sempre la fonte di verità.** I dati manuali/email sono solo provvisori per fornire una visione anticipata del saldo. Questa è la logica di business più importante da rispettare.
-   **Il file corretto è **: L'utente si riferisce alla pagina come Prima Nota Unificata, ma la navigazione e il codice puntano a . **NON** lavorare su .
-   **Stringi tutto**: È una direttiva generale dell'utente per rendere l'interfaccia più compatta e moderna. Applica questo principio durante il refactoring dell'UI.
-   **Unificare le azioni**: L'utente vuole che l'azione di spostamento sia integrata nella selezione del metodo di pagamento, non un pulsante separato. La logica in  è l'esempio da seguire.

**documents and test reports created in this job**
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Chiede di testare la nuova logica dei corrispettivi e di uniformare l'UI di Prima Nota Unificata allo stile di , compattando la card Versamenti.
2.  **User**: Chiarisce la logica dei corrispettivi/POS manuali: devono essere sempre provvisori e sovrascritti dall'XML basandosi sulla **data**, poiché non hanno una matricola.
3.  **User**: Chiede una spiegazione della logica dei corrispettivi e richiede che il pulsante Sposta sia unificato con la scelta del metodo di pagamento.
4.  **Agent**: Completa le modifiche a  e riassume il lavoro fatto.
5.  **User**: Dà istruzioni precise sulla logica di : POS unificato, pulsanti Sposta che aggiornino anche l'archivio fatture e la regola che l'import XML deve rispettare la scelta manuale dell'utente.
6.  **Agent**: Conferma la comprensione della logica completa.
7.  **Agent**: Inizia a implementare le modifiche su .
8.  **Agent**: Chiede una sintesi delle nuove richieste per assicurarsi di aver capito.
9.  **User**: Dettaglia le nuove richieste, tra cui la gestione delle fatture da email come dati provvisori, il restyling di  e la funzionalità di spostamento tra cassa e banca.
10. **Agent**: Completa i task P0 precedenti (rimozione , ecc.) e riassume il lavoro.

**Project Health Check:**
-   **Broken**: Nessuna.
-   **Mocked**: Funzionalità di parsing fatture da email (discussa ma non implementata).

**3rd Party Integrations**
-   Gmail (IMAP)
-   Claude Sonnet 4.5 (via Emergent LLM Key)
-   Tesseract OCR
-   PyMuPDF

**Testing status**
-   **Testing agent used after significant changes**: YES (nella sessione precedente).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: No
-   **Known regressions**: Nessuna.

**What agent forgot to execute**
-   Non ha ancora implementato la logica per leggere le fatture dalle email, una richiesta chiave dell'utente.
-   Non ha ancora risposto alla domanda dell'utente su come viene calcolata la data di scadenza delle fatture (issue ereditato da fork precedenti).
-   Non ha completato il refactoring dei router backend (, ).</analysis>
