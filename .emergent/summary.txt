<analysis>**original_problem_statement:**
L'utente ha sollevato una serie di problemi critici e richieste di funzionalità per migliorare la logica contabile e l'usabilità dell'applicazione ERP. Le richieste principali sono:
1.  **(P0) Logica di Importazione e Riconciliazione Fatture:** Correggere il processo di importazione delle fatture per associare automaticamente i metodi di pagamento, creare una scrittura in Prima Nota, e riconciliare con l'estratto conto bancario (impostando lo stato su riconciliato automatico se trovato, o Cassa da confermare se non trovato). Aggiungere la possibilità di visualizzare la fattura allegata dalla pagina Prima Nota Cassa.
2.  **(P1) Dati Dashboard e Calcolo IVA Errati:** I dati finanziari sulla Dashboard (es. Utile Lordo, Ricavi) non sono corretti. Esiste una discrepanza nei calcoli dell'IVA tra diverse sezioni dell'app ( e ). L'utente chiede di unificare la logica usando quella corretta e rimuovendo i duplicati.
3.  **(P2) Funzionalità di Visualizzazione Fatture (AssoSoftware):** Implementare un nuovo pulsante per visualizzare le fatture XML nel formato ufficiale AssoSoftware, ricercando lo stile corretto dal sito dell'Agenzia delle Entrate, e rendere questa funzionalità disponibile in tutte le sezioni dove si visualizza una fattura.
4.  **(P3) Bug e Miglioramenti UI:**
    *   **Ricerca P.IVA:** La ricerca per Partita IVA dei fornitori non è affidabile. Deve essere migliorata per interrogare fonti ufficiali (es. ) e completare i dati mancanti.
    *   **Dashboard:** Rimuovere una serie di card KPI (Fatture, Fornitori, Magazzino, ecc.) per compattare la vista.
    *   **Pagina Admin:** Risolvere un bug per cui l'eliminazione di una parola chiave ne rimuove un'altra. Aggiungere più parole chiave predefinite.
    *   **Archivio Bonifici:** La funzione di ricerca non funziona correttamente e manca un pulsante esplicito Cerca.
    *   **Filtro Pagina Fatture:** La pagina delle fatture non applica i filtri (fornitore, anno) passati tramite i parametri dell'URL.
    *   **Popup Ricerca Email:** Eliminare un popup di notifica relativo alla sincronizzazione degli F24 via email.
5.  **(P4) Errore Critico React:** L'applicazione si blocca a causa di un errore .

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha lavorato su molte delle richieste dell'utente, con vari gradi di successo:
1.  **Visualizzatore Fatture:** Ha implementato con successo un visualizzatore di fatture XML avanzato () che offre tre modalità di visualizzazione: Semplificata, Completa (stile AssoSoftware) e Ministeriale (stile Agenzia delle Entrate), con un selettore per passare da una all'altra.
2.  **Logica IVA:** Ha identificato e rimosso la registrazione di un router duplicato e difettoso (). Ha tentato di allineare la logica di calcolo tra i diversi endpoint per risolvere le discrepanze.
3.  **Miglioramenti UI:**
    *   Ha rimosso le card KPI dalla .
    *   Ha corretto il bug di eliminazione delle parole chiave in  risolvendo un problema con le  di React e ha aggiunto parole chiave predefinite.
    *   Ha aggiunto un pulsante Cerca in .
    *   Ha corretto la pagina  per applicare correttamente i filtri dall'URL.
    *   Ha rimosso il popup di sincronizzazione F24.
4.  **Errore React:** Ha implementato un  in  come soluzione temporanea per evitare che l'applicazione si blocchi, ma la causa principale dell'errore non è stata risolta.
5.  **Logica di Importazione Fatture:** Ha iniziato un'importante modifica per correggere il flusso di importazione e riconciliazione, modificando i file ,  e .

**Last working item**:
- **Last item agent was working**: L'agente era nel mezzo della modifica della logica di importazione e riconciliazione delle fatture per soddisfare l'ultima e più critica richiesta dell'utente. Il lavoro consiste nell'assicurare che, durante l'upload di una fattura, il sistema associ correttamente il metodo di pagamento, crei una scrittura in Prima Nota e tenti una riconciliazione automatica con l'estratto conto.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: both. È necessario un test end-to-end. Per il backend, caricare un file di fattura e verificare con  o  che i dati nel database (collection , ) siano corretti. Per il frontend, usare lo screenshot tool per confermare che il pulsante per visualizzare l'allegato sia presente e funzionante in .
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1: (P0) Completare la correzione della logica di importazione, riconciliazione e Prima Nota.**
  - **Description**: Questa è l'attività corrente e la massima priorità. L'implementazione è iniziata ma non è completa né testata.
  - **Status**: IN PROGRESS
- **Issue 2: (P1) Correggere i dati finanziari sulla Dashboard e il calcolo dell'IVA.**
  - **Description**: L'utente ha segnalato che i dati sulla Dashboard (es. Utile Lordo) sono errati. Questo è probabilmente legato a una logica di calcolo dell'IVA ancora imperfetta, nonostante i tentativi di fix.
  - **Status**: IN PROGRESS
- **Issue 3: (P2) Risolvere la causa principale dell'errore React .**
  - **Description**: L'agente ha aggiunto un  come cerotto, ma l'errore di fondo persiste e può causare instabilità.
  - **Status**: NOT STARTED
- **Issue 4: (P3) Migliorare l'affidabilità della ricerca P.IVA.**
  - **Description**: L'attuale implementazione basata su scraping non è sufficiente. È necessario integrare una fonte dati più affidabile come richiesto dall'utente.
  - **Status**: NOT STARTED
- **Issue 5: (P4) Verificare e correggere la funzione di ricerca in .**
  - **Description**: L'utente ha segnalato che la ricerca non funziona, nonostante l'agente creda di averla sistemata. Il comportamento anomalo (il numero di risultati aumenta dopo una ricerca) deve essere investigato.
  - **Status**: NOT STARTED

**In progress Task List**:
- **Task 1: Terminare l'implementazione del flusso di importazione fatture.**
  - **Where to resume**: L'agente ha modificato i file ,  e . Il prossimo passo è riavviare i servizi ed eseguire un test completo end-to-end, caricando la fattura fornita dall'utente e verificando ogni passaggio del processo.
  - **Status**: IN PROGRESS

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **(P1) Parser PDF per Cespiti**: Preparare il modulo Cespiti per leggere i dati da un file PDF di bilancio.
    *   **(P2) Semplificazione Previsioni Acquisti**: Aggregare i prodotti per tipologia.
    *   **(P2) Miglioramento Ricerca Prodotti**: Affinare la logica di categorizzazione.
*   **Future Tasks**:
    *   Nessun task futuro definito al momento.

**Completed work in this session**
- Implementato un visualizzatore di fatture XML multi-vista (, , ).
- Corretto un bug di eliminazione delle parole chiave nella pagina Admin e aggiunte nuove parole chiave predefinite.
- Unificata parzialmente la logica di calcolo IVA rimuovendo un router duplicato.
- Aggiunto un pulsante Cerca e implementata la creazione di ZIP per dipendente nella pagina .
- Corretta la logica di filtraggio basata su URL nella pagina .
- Rimosse le card KPI dalla Dashboard per un layout più compatto.
- Rimosso il popup di notifica per la sincronizzazione degli F24.

**Earlier issues found/mentioned but not fixed**
Nessuno.

**Known issue recurrence from previous fork**
Nessuno.

**Code Architecture**


**Key Technical Concepts**
- **Backend**: FastAPI con MongoDB (tramite ). Logica di business complessa per calcoli contabili e riconciliazioni implementata tramite aggregation pipeline di MongoDB.
- **Frontend**: React, , . Uso di  per modali e  per la gestione degli errori.
- **Data Handling**: Parsing di file XML () per le fatture elettroniche, scraping web per dati aziendali.

**key DB schema**
- **invoices**: Documento centrale per le fatture. Campi come , , ,  sono in fase di modifica per riflettere lo stato corretto del pagamento. Contiene un riferimento () al file XML originale.
- **prima_nota**: Collezione per le scritture contabili. È stato aggiunto un campo  per collegare la scrittura alla fattura corrispondente.
- **bank_transactions**: Movimenti bancari importati dall'estratto conto, usati per la riconciliazione.
- **configurations**: Memorizza impostazioni globali, incluse le  per la ricerca di documenti.

**All files of reference**
-  (core della logica di importazione)
-  (gestione scritture contabili)
-  (UI per visualizzare le scritture)
-  (una delle logiche di calcolo IVA)
-  (l'altra logica di calcolo IVA)
-  (dove vengono visualizzati i dati finanziari errati)
-  (dove è stato aggiunto l'ErrorBoundary)

**Areas that need refactoring**:
- **Logica di Calcolo IVA**: Esistono ancora due implementazioni separate per il calcolo dell'IVA ( e ). Devono essere consolidate in un unico servizio affidabile per garantire coerenza dei dati in tutta l'applicazione.

**key api endpoints**
- : Endpoint per il caricamento delle fatture, attualmente in fase di modifica.
- : Endpoint usato dalla pagina , la cui logica è stata modificata.
- : Endpoint usato dalla pagina .
- : Nuovo endpoint per recuperare il file di una fattura da una scrittura di prima nota.
- : Ricerca dati fornitore tramite P.IVA.
- : Rimuove una parola chiave.

**Critical Info for New Agent**
- L'utente è estremamente frustrato dallo stato della logica contabile. La priorità assoluta è correggere il flusso di importazione fatture, la riconciliazione e la Prima Nota. Questa funzionalità deve essere robusta e completamente automatica.
- L'errore  è stato solo mascherato con un . Se l'app si blocca di nuovo, la causa è lì. Indagare sui componenti che usano  o che vengono rimossi condizionalmente dal DOM.
- Il database nell'ambiente di preview è spesso vuoto. La logica deve essere sviluppata per funzionare correttamente anche in assenza di dati e non deve fare affidamento su dati preesistenti per i test.
- L'utente è molto preciso nel segnalare i bug. Presta la massima attenzione ai file e agli screenshot forniti per riprodurre e risolvere i problemi.

**documents and test reports created in this job**
Nessuno.

**Last 10 User Messages and any pending HUMAN messages**
Le ultime interazioni con l'utente sono una serie di segnalazioni di bug critici. L'utente ha espresso forte frustrazione per la scorrettezza dei calcoli contabili e l'incompletezza delle funzionalità implementate. Ha caricato file di esempio e indicato esattamente dove i dati non tornano, aspettandosi una soluzione definitiva.

**Project Health Check:**
- **Broken**: La logica contabile di base (importazione fatture, riconciliazione, calcolo IVA, reportistica su Dashboard) è considerata dall'utente come non funzionante o inaffidabile. Anche il frontend soffre di un'instabilità di fondo (errore ).

**3rd Party Integrations**
- **xml.etree.ElementTree**: Utilizzato per il parsing dei file XML delle fatture.
- Nessun'altra nuova integrazione in questa sessione.

**Testing status**
- **Testing agent used after significant changes**: NO
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: Nessuno.
- **Known regressions**: I dati sulla Dashboard sono peggiorati o sono stati evidenziati come errati dopo le modifiche.

**Credentials to test flow:**
- Non necessarie per i task attuali.

**What agent forgot to execute**
- L'agente non ha risolto la causa principale dell'errore React .
- L'agente non ha unificato completamente la logica di calcolo dell'IVA in un unico servizio, lasciando due implementazioni separate.
- L'agente non ha verificato nuovamente la funzionalità di ricerca in  dopo la segnalazione dell'utente, fidandosi del proprio test iniziale che però mostrava un comportamento anomalo.</analysis>
