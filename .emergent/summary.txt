<analysis>**original_problem_statement:**
L'utente ha richiesto una serie di funzionalità e correzioni di bug per la sua applicazione gestionale ERP. Le richieste principali includono:
1.  **Logica Contabile (Partite di Giro)**: Correggere i calcoli finanziari per rispettare i principi contabili, in particolare le partite di giro. Ad esempio, i salari pagati dalla banca non devono essere sommati due volte nelle uscite totali.
2.  **Correzione Bug**:
    *   : Il totale delle uscite era errato (€1.261.716,20 invece di €967.794,71) a causa di un endpoint duplicato e del doppio conteggio dei salari.
    *   : La vista trimestrale e annuale mostravano dati identici e i dati per i mesi specifici non venivano visualizzati correttamente.
    *   : Le funzioni di download PDF e invio email erano segnalate come non funzionanti.
3.  **Nuove Funzionalità e UI**:
    *   : Aggiungere card per Pagato Non Riscosso e Ammontare Annulli, estraendo i dati dai file XML.
    *   : Sostituire il selettore di date con bottoni per i mesi e aggiungere una pagina di dettaglio per le singole transazioni.
    *   : Aggiungere una barra di ricerca e la selezione multipla per i carnet degli assegni.
    *   : Ristrutturare completamente la pagina per allinearla a un esempio fornito, includendo la gestione delle buste paga mensili e una Prima Nota Salari.
4.  **Coerenza UI (Filtro Anno Globale)**: Forzare l'utilizzo di un unico selettore di anno globale per tutte le pagine, disabilitando la ricerca di dati per anni diversi da quello selezionato per prevenire errori e confusione.
5.  **Logica di Business Specifica**:
    *   **POS Banca**: Implementare una logica di calcolo complessa basata sul codice  e sulle regole di sfasamento temporale degli accrediti.
    *   **Importazione XML**: Risolvere un errore che impedisce di re-importare i file XML per aggiornare i dati (es. dato già inserito).

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha lavorato su gran parte delle richieste.
- **Fix **: È stato identificato e risolto un bug critico nel backend, causato da un endpoint duplicato ( in ) che non applicava il filtro per anno. La logica di calcolo è stata corretta per non contare due volte i salari (partite di giro).
- **Fix **: Le card principali ora mostrano i totali per l'anno selezionato (invece di Oggi). È stato chiarito che la somiglianza tra vista annuale e trimestrale era dovuta alla visualizzazione dei dati del 2026 (con solo il Q1 popolato).
- **Nuove Card **: Sono state implementate le card Pagato Non Riscosso e Ammontare Annulli. Il parser XML () è stato aggiornato e un endpoint di backfill ha aggiornato 359 record esistenti.
- **UI  e **: La pagina  ora ha i bottoni per i mesi. La pagina  ha una nuova interfaccia per la ricerca e la selezione multipla dei carnet di assegni.
- **Sincronizzazione Anno Globale**: L'agente ha iniziato a rimuovere i selettori di anno locali dalle pagine (, ) per forzare l'uso del context globale, ma questo ha introdotto un nuovo bug.

**Last working item**:
- **Last item agent was working**: L'agente stava finalizzando il fix della pagina . Dopo aver corretto la logica del backend (rimozione endpoint duplicato e gestione partite di giro), ha modificato il frontend per rimuovere il selettore di anno locale e usare il context globale. Questo ha causato la rottura della pagina.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N (Il backend è stato testato con  e funziona, ma il frontend è rotto).
- **Which testing method agent to use?**: Frontend testing agent. Prima di tutto, l'agente deve ispezionare la console del browser e i log di Vite per capire perché la pagina  è bianca. Una volta risolto, il testing agent dovrà verificare:
    1.  Il corretto caricamento della pagina  senza errori.
    2.  Che le uscite totali per il 2025 corrispondano a **€967.794,71**.
    3.  Che il dettaglio delle uscite (Cassa, Banca) sia corretto e non includa più i salari nel totale generale.
    4.  Il corretto funzionamento del filtro anno globale sulla pagina.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1: La pagina  è bianca (P0)**
    - **Attempted fixes**: L'agente ha rimosso il selettore di anno locale per usare il context globale. Questa modifica ha causato il problema.
    - **Next debug checklist**:
        1.  Controllare la console del browser per errori JavaScript (es. ).
        2.  Verificare che il componente  riceva correttamente i dati dal .
        3.  Assicurarsi che la rimozione del codice del vecchio dropdown non abbia lasciato tag JSX aperti o sintassi invalida.
    - **Why fix this issue and what will be achieved with the fix?**: È un bloccante critico. Risolverlo completerà il fix della logica finanziaria e della sincronizzazione dell'anno per questa pagina.
    - **Status**: IN PROGRESS
    - **Is recurring issue?**: N
    - **Should Test frontend/backend/both after fix?**: frontend
    - **Blocked on other issue**: No

**In progress Task List**:
- **Task 1: Completare il refactoring Partite di Giro e Sincronizzazione Anno (P0)**
    - **Where to resume**: Debuggare il file  per risolvere l'errore che causa la pagina bianca.
    - **What will be achieved with this?**: La pagina Finanziaria visualizzerà i dati contabili corretti, allineati ai principi di ragioneria e sincronizzati con il filtro anno globale, risolvendo una delle principali richieste dell'utente.
    - **Status**: IN PROGRESS
    - **Should Test frontend/backend/both after fix?**: both
    - **Blocked on something**: La pagina bianca (Issue 1).

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
    - **(P1)  - Pagina Dettaglio Transazione**: Implementare la funzionalità per cui cliccando su una riga della tabella si apre una nuova vista con i dettagli specifici di quella transazione.
    - **(P2) Logica di Accredito POS**: Implementare la regola di sfasamento temporale per gli accrediti POS (pagamento lunedì -> accredito martedì, venerdì -> lunedì, ecc.), considerando anche i giorni festivi.
    - **(P2) Fix Errore Re-importazione XML**: Modificare la logica di importazione dei file XML per usare un meccanismo di  (o ) invece di un semplice , per permettere l'aggiornamento dei corrispettivi esistenti quando i file vengono ricaricati.
- **Future Tasks**:
    - **(P0) Ristrutturazione **: Task di grandi dimensioni per riprogettare la pagina di gestione dei dipendenti in base all'esempio fornito, includendo schede per Paghe e Salari, visualizzazione delle buste paga mensili e una nuova pagina Prima Nota Salari.
    - **(P2) Popolare Magazzino da Fatture XML**: Task in sospeso per estrarre i prodotti dalle fatture di acquisto XML per popolare l'inventario.
    - **(P2) Export PDF per Riepilogo IVA**: Aggiungere una funzionalità per esportare in PDF il riepilogo trimestrale dell'IVA.

**Completed work in this session**
- **Fix Calcolo Spese **: Identificato e rimosso un endpoint API duplicato che causava totali errati. La logica è stata allineata ai principi contabili (partite di giro).
- **Miglioramento UI **: Le card principali ora mostrano i totali per l'anno selezionato, rendendo la pagina più chiara. Aggiunta una vista trimestrale.
- **Implementazione Nuove Card **: Aggiunte le card Pagato Non Riscosso e Ammontare Annulli, aggiornando il parser XML e i dati esistenti nel DB.
- **Refactoring UI  e **: Sostituito il selettore data in  con bottoni per i mesi. Aggiunta ricerca e multiselezione per gli assegni in .
- **Fix Calcolo POS Banca**: Implementata la nuova logica di calcolo basata sul codice .
- **Conferma Calcolo Aliquote IVA**: Verificato che il backend calcoli correttamente l'IVA includendo tutte le aliquote (4%, 5%, 10%, 22%) presenti nei dati.

**Earlier issues found/mentioned but not fixed**
- **Issue 1: Logica di sfasamento accrediti POS**: Menzionata dall'utente ma non ancora implementata. Ora è un Upcoming Task.
- **Issue 2: Errore re-importazione XML**: L'utente ha segnalato che non può aggiornare i dati reimportando i file. Questo è ora un Upcoming Task.

**Known issue recurrence from previous fork**
- **Discrepanza Anno Selezionato**: Problema ricorrente in cui le pagine usano l'anno di sistema (2026) invece dell'anno selezionato dall'utente (2025). L'agente ha iniziato a risolverlo centralizzando la gestione dell'anno con , ma il lavoro è ancora in corso e ha causato il bug corrente sulla pagina Finanziaria.
- **Recurrence count**: 2+
- **Status**: IN PROGRESS

**Code Architecture**


**Key Technical Concepts**
- **Partite di Giro (Contra Entries)**: Concetto contabile fondamentale per cui i trasferimenti interni (es. stipendi pagati da banca) non devono essere conteggiati due volte nei totali. Applicato in .
- **Debug di Endpoint Duplicati**: È stato risolto un bug critico causato da una rotta API duplicata in . Questo evidenzia la necessità di verificare la presenza di codice legacy conflittuale.
- **Data Backfilling**: Creazione di un endpoint API () per aggiornare in massa i dati esistenti dopo una modifica al parser.
- **Global State Management (React Context)**: Refactoring in corso per centralizzare la gestione dello stato dell'anno () e garantire la coerenza tra le pagine.

**key DB schema**
- **corrispettivi**: Contiene i dati degli scontrini elettronici. Aggiornato con  e .
- **estratto_conto**: Contiene i movimenti bancari, usati per il calcolo del POS Banca.
- **prima_nota**: Contiene i movimenti di cassa.
- **invoices**: Contiene i dati delle fatture, incluso  con il dettaglio delle aliquote.

**changes in tech stack**
- Nessuna.

**All files of reference**
-  (Modificato, attualmente non funzionante)
-  (Modificato per correggere calcolo e logica contabile)
-  (Modificato per rimuovere endpoint duplicato)
-  (Modificato per migliorare UX e sincronizzare l'anno)
-  (Modificato per aggiungere ricerca e multiselezione assegni)
-  (Modificato per usare bottoni per i mesi)
-  (Aggiornato per estrarre nuovi campi XML)
-  (Aggiunto endpoint per il backfill)
-  (Aggiornato)

**Areas that need refactoring**:
- La sincronizzazione dell'anno tramite  deve essere completata e stabilizzata su tutte le pagine rilevanti per risolvere definitivamente il problema dell'anno non corretto.

**key api endpoints**
- : (FIXED) Restituisce il riepilogo finanziario per l'anno specificato.
- : Restituisce il riepilogo IVA annuale.
- : (NEW) Endpoint per il ricalcolo dei campi sui corrispettivi esistenti.

**Critical Info for New Agent**
- **Priorità #1: Risolvere la pagina bianca su **. Questo è un bloccante introdotto durante l'ultimo refactoring e deve essere risolto immediatamente.
- **La logica contabile è fondamentale**: L'utente è molto attento ai dettagli contabili. Fai riferimento al concetto di partite di giro e al PDF  fornito per evitare errori di calcolo come il doppio conteggio.
- **Completare la sincronizzazione dell'anno**: Il bug dell'anno errato è un problema ricorrente. È necessario completare il refactoring per usare  su tutte le pagine rilevanti e testare a fondo la sua funzionalità.
- **Attenzione al codice legacy/duplicato**: Un bug critico è stato causato da un endpoint duplicato. Se un'API si comporta in modo anomalo, usa  per cercare definizioni di rotta conflittuali in tutto il progetto.

**documents and test reports created in this job**
- 
- 
- 
- 
- User artifact: 

**Last 10 User Messages and any pending HUMAN messages**
1.  **LATEST**: continua - Esortazione a procedere.
2.  **Richiesta Logica Contabile**: Spiegazione delle partite di giro e richiesta di applicare i principi di ragioneria, sincronizzare l'anno globale e usare un libro di ragioneria fornito come riferimento.
3.  **Dettagli Implementazione**: Chiarimenti sull'errore di re-importazione XML, conferma del valore delle uscite e conferma sulla riprogettazione della pagina dipendenti.
4.  **Segnalazione Bug Multipla**: Bug sulla pagina IVA (dati uguali, mese non funzionante), sulla pagina Finanziaria (uscite errate) e richiesta di nuove funzionalità (dettaglio transazione in Prima Nota, riprogettazione pagina dipendenti).
5.  **Dettagli per Nuove Card**: Specifiche tecniche per calcolare Pagato Non Riscosso e trovare Ammontare Annulli nei file XML.
6.  **Segnalazione Bug e Feature Request**: Bug su PDF/Email nella pagina  e richiesta di ricerca/selezione assegni; richiesta di UI a bottoni in ; richiesta di nuove card in .
7.  **Conferma Logica POS Banca**: Dettagli confermati per il fix della logica del POS Banca.
8.  **Segnalazione Bug POS Banca**: L'utente segnala che il calcolo del POS Banca è errato e fornisce una nuova logica complessa.
9.  **Approvazione Piano Iniziale**: L'utente approva l'esecuzione dei task P0 e P1.
10. **Richiesta Iniziale**: Messaggio di inizio conversazione.

**Project Health Check:**
- **Broken**: La pagina  è attualmente bianca e non funzionante.
- **Mocked**: None

**3rd Party Integrations**
- Nessuna.

**Testing status**
- **Testing agent used after significant changes**: YES
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: [paths] No
- **Known regressions**: La pagina  è diventata non funzionante (bianca) dopo l'ultimo refactoring.

**Credentials to test flow:**
N/A

**What agent forgot to execute**
- Non ha ancora implementato la logica complessa di sfasamento degli accrediti POS.
- Non ha ancora creato la pagina di dettaglio per le transazioni in .
- Non ha ancora iniziato la ristrutturazione della pagina .
- Non ha risolto il problema della re-importazione dei file XML.</analysis>
