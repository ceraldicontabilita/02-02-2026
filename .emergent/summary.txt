<analysis>
**original_problem_statement:**
L'utente ha richiesto l'aggiunta di diverse funzionalità a un'applicazione ERP:
1.  **Funzionalità di Produzione e Lotti**.
2.  **Riconciliazione F24 a 3 Livelli** (Download email, Parsing PDF, Dashboard di riconciliazione).
3.  **Parsing Buste Paga**.
4.  **Calcolo Liquidazione IVA**.
5.  **Comparatore Prezzi Fornitori**.

La richiesta più recente e complessa è di implementare un sistema avanzato di gestione degli F24:
*   Gestire F24 originali e le loro versioni corrette (ravvedimento).
*   Se viene pagato un F24 con ravvedimento, la versione originale deve essere archiviata o annullata.
*   Se viene pagato un F24 originale in ritardo, il sistema deve segnalare che è da ravvedere.
*   Riconciliare automaticamente i pagamenti degli F24 con i movimenti dell'estratto conto bancario.
*   Creare un database dei singoli codici tributo pagati, filtrabile per anno, codice e sezione (Es. Erario, INPS).
*   Generare report mensili su F24 pagati e non pagati, con un sistema di allarmi (alert).

**User's preferred language**: Italiano

**what currently exists?**
*   I moduli di Produzione, Liquidazione IVA, Parser Buste Paga e Comparatore Prezzi sono stati implementati.
*   **Parser F24**: Il parser per gli F24 del commercialista () è stato completamente riscritto. Ora è molto robusto e utilizza l'analisi basata sulle coordinate per distinguere correttamente tra colonne di debito e credito. Gestisce vari formati di F24 (standard, IVA, IMU, con ravvedimento) e diverse sezioni (Erario, INPS, INAIL, Regioni, Tributi Locali).
*   **Parser Estratto Conto**: È stato implementato un parser () per i file CSV degli estratti conto di Banco BPM e un servizio API iniziale per la riconciliazione.
*   **Refactoring Backend**: L'intera struttura dei router del backend è stata riorganizzata in un'architettura modulare basata sulle funzionalità (es. , ), migliorando l'organizzazione del codice.
*   **Frontend**: Esiste una dashboard di base per la riconciliazione F24 ().

**Last working item**:
*   **Last item agent was working**: Avvio dell'implementazione della logica di gestione avanzata degli F24, come richiesto dall'utente. È stato creato il file di servizio  per ospitare la nuova logica complessa di gestione delle versioni originali e con ravvedimento degli F24.
*   **Status**: IN PROGRESS
*   **Agent Testing Done**: N
*   **Which testing method agent to use?**: backend testing agent. Sarà necessario testare la complessa logica di business che gestisce F24 originali vs. ravveduti, la corrispondenza con l'estratto conto e gli aggiornamenti di stato. Sarà utile anche  per testare i nuovi endpoint API.
*   **User Testing Done**: N

**All Pending/In progress Issue list**:
*   **Issue 1: Implementare la logica avanzata di gestione F24 (ravvedimento e riconciliazione) (P0)**
*   **Issue 2: Click sui tab non funzionante nei test automatici in  (P2)**

**Issues Detail:**
-   **Issue 1:**
    -   **Attempted fixes**: È stato creato il file . La logica di base deve ancora essere scritta.
    -   **Next debug checklist**:
        1.  Implementare la logica in  per gestire i requisiti dell'utente:
            *   Modificare lo schema del DB per F24 per includere campi come  ('originale', 'ravveduto', 'annullato') e .
            *   Creare una funzione per identificare se un F24 è la versione ravveduta di un altro.
            *   Aggiornare il servizio di riconciliazione bancaria per marcare lo stato corretto degli F24 in base ai pagamenti trovati sull'estratto conto.
        2.  Creare nuovi endpoint API in un router dedicato (es. ).
        3.  Creare una nuova collection nel DB () per archiviare i dati granulari dei tributi pagati.
        4.  Implementare un'API per generare i report mensili richiesti.
    -   **Why fix this issue and what will be achieved with this?**: È una funzionalità core richiesta dall'utente per automatizzare un processo finanziario critico, fornendo un tracciamento accurato di pagamenti e passività fiscali.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: None
-   **Issue 2:**
    -   **Attempted fixes**: Nessuno in questa sessione.
    -   **Next debug checklist**: Eseguire il  specificamente sulla pagina  per replicare il problema e analizzare l'interazione con i componenti Tab di .
    -   **Why fix this issue and what will be achieved with this?**: Sbloccare test E2E affidabili per una parte critica dell'applicazione.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: None

**In progress Task List**:
-   **Task 1: Implementare il sistema avanzato di gestione F24 (P0)**
    -   **Where to resume**: Dal file , che al momento è vuoto. È necessario scrivere la logica di business e creare le relative API.
    -   **What will be achieved with this?**: Un sistema di riconciliazione F24 completamente automatizzato che gestisce le correzioni (ravvedimento) e fornisce report dettagliati.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on something**: None

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **(P0) Creare Frontend per Riconciliazione Avanzata F24**: Sviluppare una nuova pagina UI per visualizzare i risultati della riconciliazione avanzata, lo stato di ogni F24 e il report mensile dei tributi pagati.
    -   **(P1) Testare il Parsing delle Buste Paga**: L'utente deve ancora fornire file PDF di esempio per testare il .
    -   **(P2) UI per il Comparatore Prezzi**: Integrare la funzionalità del comparatore prezzi nella pagina frontend .
-   **Future Tasks**:
    -   Valutare e integrare un'API bancaria (come Salt Edge, Plaid, Tink o Fabrick) per sostituire il caricamento manuale del file CSV.
    -   Gestire l'inventario fisico e la .
    -   Costruire una dashboard di controllo di gestione completa.

**Completed work in this session**
-   **Correzione Bug Critico Parser F24**: Il file  è stato completamente riscritto. Il nuovo parser ora gestisce layout complessi, distingue correttamente debiti/crediti tramite coordinate e processa vari tipi di F24 (standard, IMU, ravvedimento).
-   **Refactoring del Backend**: L'intera directory dei router () è stata riorganizzata in una struttura modulare per migliorare l'organizzazione e la manutenibilità del codice.
-   **Parsing Estratto Conto Bancario**: Creato un parser per i file  di Banco BPM e un'API iniziale per la riconciliazione bancaria.
-   **Risoluzione Blocchi di Deployment**: Corretti problemi nel  e nel file  del frontend che impedivano il deployment.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Click sui tab non funzionante nei test automatici in **. Problema ricorrente non ancora affrontato.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Fallimento dei test automatici su .
-   **Recurrence count**: 3+
-   **Status**: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Parsing PDF Avanzato con Coordinate**: L'agente è passato dall'uso di espressioni regolari a un'analisi basata su coordinate (x, y) tramite usage: pdfplumber [-h] [--structure | --structure-text]
                  [--format {csv,json,text}] [--types TYPES [TYPES ...]]
                  [--include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]]
                  [--exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]]
                  [--laparams LAPARAMS] [--precision PRECISION]
                  [--pages PAGES [PAGES ...]] [--indent INDENT]
                  [infile]

positional arguments:
  infile

options:
  -h, --help            show this help message and exit
  --structure           Write the structure tree as JSON. All other arguments
                        except --pages, --laparams, and --indent will be
                        ignored
  --structure-text      Write the structure tree as JSON including text
                        contents. All other arguments except --pages,
                        --laparams, and --indent will be ignored
  --format {csv,json,text}
  --types TYPES [TYPES ...]
  --include-attrs INCLUDE_ATTRS [INCLUDE_ATTRS ...]
                        Include *only* these object attributes in output.
  --exclude-attrs EXCLUDE_ATTRS [EXCLUDE_ATTRS ...]
                        Exclude these object attributes from output.
  --laparams LAPARAMS
  --precision PRECISION
  --pages PAGES [PAGES ...]
  --indent INDENT       Indent level for JSON pretty-printing. per interpretare correttamente la struttura a colonne dei PDF F24.
-   **Refactoring Modulare del Backend**: Il backend FastAPI è stato ristrutturato da una lista piatta di router a un'architettura modulare basata su domini di business, migliorando scalabilità e manutenibilità.
-   **Logica Finanziaria Complessa**: La nuova richiesta di gestione degli F24 introduce una logica stateful che richiede di tracciare le relazioni tra documenti (originale vs. corretto) e il loro stato di pagamento.

**key DB schema**
-   **f24_commercialista**: . Dovrebbe essere esteso con campi come  ('originale', 'ravveduto', 'annullato') e .
-   **estratto_conto_movimenti**: .
-   **(DA CREARE) codici_tributo_pagati**: .

**All files of reference**
-   : File chiave per la prossima task.
-   : Il parser F24, ora robusto e completo.
-   : Il parser per gli estratti conto.
-   : Entry point dell'applicazione, ora refattorizzato.
-   : Documentazione della nuova architettura backend.

**Areas that need refactoring**:
-   La cartella  potrebbe essere a sua volta modularizzata per rispecchiare la nuova struttura dei router (es. , ).

**key api endpoints**
-   : Carica e analizza un PDF F24.
-   : Carica e analizza un estratto conto in formato CSV.
-   : Esegue una riconciliazione di base tra F24 e movimenti bancari.

**Critical Info for New Agent**
-   La priorità assoluta (P0) è implementare la logica avanzata di gestione degli F24 come richiesto dall'utente. Questo include la gestione del ravvedimento, l'archiviazione delle versioni obsolete e la segnalazione di quelle da correggere.
-   Il backend è stato appena refattorizzato. Qualsiasi nuovo codice deve seguire la struttura modulare esistente.
-   Il parser F24 in  è ora molto stabile e non dovrebbe essere modificato a meno di nuovi formati PDF.
-   L'integrazione con Fabrick è un'attività futura. La logica attuale deve basarsi sul file CSV dell'estratto conto caricato manualmente.

**documents and test reports created in this job**
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
10. **Richiesta utente (PENDING):** Implementare una logica avanzata per F24 con ravvedimento, riconciliazione bancaria e reportistica dettagliata dei tributi pagati.
9.  **Utente (Completato):** Conferma che la logica per F24 a saldo zero è corretta e chiede di procedere.
8.  **Agente (Completato):** Chiede chiarimenti sul motivo per cui un F24 ha saldo zero.
7.  **Utente (Completato):** Segnala errori nel parsing del totale di un F24 e la mancanza di alcuni tributi. Questo ha portato alla riscrittura del parser.
6.  **Agente (Completato):** Comunica la risoluzione (errata) del bug del parser.
5.  **Utente (Completato):** Chiede di refattorizzare il backend in moduli.
4.  **Utente (Completato):** Conferma che il nuovo parser funziona e chiede di caricare gli F24 nel DB.
3.  **Utente (Completato):** Chiede di procedere con il piano.
2.  **Utente (Completato):** Fornisce 3 nuovi PDF F24 complessi per il testing.
1.  **Utente (Completato):** Chiarisce la logica di un F24 multi-pagina, confermando che sono documenti separati.

**Project Health Check:**
-   **Broken**: Nessuno. Il bug critico del parser F24 è stato risolto.
-   **Mocked**: Nessuno.

**3rd Party Integrations**
-   **Google/Gmail (IMAP)**: Per scaricare allegati F24.
-   **pdfplumber**: Per il parsing dei PDF.
-   **Fabrick (Futuro)**: L'utente ha espresso interesse, ma l'implementazione non è una priorità attuale.

**Testing status**
-   **Testing agent used after significant changes**: YES
-   **Test files created**: 
-   **Known regressions**: Una regressione importante nel parser F24 è stata identificata e risolta durante questa sessione.

**Credentials to test flow:**
-   **Email User**: 
-   **Email App Password**:  (disponibile in )

**What agent forgot to execute**
Nessuna dimenticanza critica. L'agente ha affrontato con successo la complessità del parsing degli F24, ha eseguito il refactoring richiesto e ha preparato il terreno per la prossima importante funzionalità richiesta dall'utente.
</analysis>
