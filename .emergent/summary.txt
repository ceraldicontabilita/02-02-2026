<analysis>**original_problem_statement:**
L'utente ha segnalato una serie di bug critici e ha espresso forte frustrazione. Le richieste originali includevano il crash della pagina , fallimenti nell'importazione di file, e numerosi errori di logica contabile.

Durante la sessione, le priorità si sono evolute per concentrarsi su:
1.  **Correzione e Refactoring della Prima Nota (P0):** L'utente ha richiesto una revisione completa della logica contabile con regole non standard:
    *   Separare completamente i conti CASSA (Contanti) e BANCA (Banca).
    *   Logica DARE/AVERE invertita: i corrispettivi (incassi) vanno in **AVERE**, e tutte le uscite (pagamenti) in **DARE**.
    *   Ogni conto deve avere un saldo progressivo che tenga conto del riporto degli anni precedenti.
2.  **Importazione e Riconciliazione Cedolini Paga (P0):** L'utente ha richiesto una nuova architettura per la gestione dei cedolini, che includesse l'estrazione di dati da PDF, l'importazione da Excel per i dati storici, e un'interfaccia per la riconciliazione manuale dei pagamenti (contanti, bonifico, assegno).
3.  **Anagrafica Fornitori (P1):** L'utente ha richiesto di correggere i fornitori senza nome importando i dati da un file Excel e di garantire che il metodo di pagamento venga sempre letto dall'anagrafica del fornitore, ignorando quanto specificato nel file XML della fattura.
4.  **Import Corrispettivi (P1):** L'utente ha segnalato che l'importazione dei file XML dei corrispettivi falliva, segnalando erroneamente i file come duplicati.

**PRODUCT REQUIREMENTS:**
-   La logica contabile deve seguire le precise, anche se non convenzionali, direttive dell'utente.
-   Le funzionalità di importazione dati (cedolini, fornitori, corrispettivi) devono essere affidabili e robuste.
-   I dati devono essere coerenti tra le varie sezioni (es. il metodo di pagamento di un fornitore deve essere lo stesso ovunque).
-   L'interfaccia utente deve essere chiara, eliminando sezioni duplicate o confuse (es. Pagina Corrispettivi vs. Prima Nota).

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha completato con successo diverse richieste chiave:
1.  **Prima Nota**: È stata implementata la logica di separazione tra CASSA e BANCA. È stato aggiunto il calcolo del saldo che include il riporto dall'anno precedente.
2.  **Cedolini & Riconciliazione**: È stata creata una nuova pagina dedicata () che mostra lo stato di ogni cedolino (Da Pagare, Pagato). È stato creato un endpoint per migrare i pagamenti storici degli stipendi dalla vecchia Prima Nota Salari alla nuova struttura, e la migrazione è stata eseguita con successo (156 cedolini aggiornati).
3.  **Anagrafica Fornitori**: È stato creato un endpoint per importare/aggiornare i fornitori da un file Excel fornito dall'utente, risolvendo il problema dei fornitori senza nome. La logica di pagamento delle fatture è stata modificata per usare **esclusivamente** il metodo di pagamento definito nell'anagrafica del fornitore.
4.  **Import Corrispettivi**: Il bug dei duplicati è stato risolto. L'agente ha scoperto che i corrispettivi venivano importati correttamente nella , ma una pagina separata e obsoleta (Corrispettivi) puntava a una collection vuota, creando confusione.

**Last working item**:
-   **Last item agent was working**: L'utente ha identificato un nuovo bug critico: nella **Prima Nota Cassa** sono presenti fatture che risultano pagate tramite **Banca**. L'agente aveva appena iniziato a investigare questo problema.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: backend testing agent (il problema risiede nella logica di registrazione dei pagamenti che non indirizza correttamente il movimento al giusto registro contabile).
-   **User Testing Done**: Y (L'utente ha rilevato l'incongruenza).

**All Pending/In progress Issue list**:
-   **Issue 1**: (P0) Le fatture pagate tramite Banca vengono registrate erroneamente nella Prima Nota Cassa.
-   **Issue 2**: (P1) Errore generico  durante l'import di altri tipi di file (es. estratto conto), menzionato nella sessione precedente ma non affrontato.
-   **Issue 3**: (P1) Logica di estrazione dei costi per la flotta auto non funzionante.
-   **Issue 4**: (P1) Perdita dei dati relativi agli IBAN multipli per i dipendenti.
-   **Issue 5**: (P2) Mancano i pulsanti Modifica ed Elimina per la gestione degli acconti dei dipendenti.

**Issues Detail**:
-   **Issue 1: Pagamenti Banca in Prima Nota Cassa**
    -   **Attempted fixes**: Nessuno. L'agente ha appena riconosciuto il problema.
    -   **Next debug checklist**:
        1.  Rivedere l'endpoint che gestisce il pagamento delle fatture (probabilmente  in ).
        2.  Verificare la funzione  per assicurarsi che, quando il metodo di pagamento è banca o bonifico, il movimento venga salvato **esclusivamente** nella collection .
        3.  Controllare che non ci siano flussi di codice alternativi (es. da ) che registrino pagamenti in cassa per errore.
    -   **Why fix this issue and what will be achieved with the fix?**: È un errore contabile critico che vanifica la separazione tra Cassa e Banca, una delle richieste fondamentali dell'utente.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Backend

**In progress Task List**:
-   **Task 1: Riorganizzare la pagina Corrispettivi (Opzione 2)**
    -   **Where to resume**: L'utente ha scelto l'opzione 2: trasformare la pagina Corrispettivi in una vista filtrata della Prima Nota Cassa. Bisogna modificare il componente frontend della pagina Corrispettivi affinché carichi i dati dall'endpoint , applicando un filtro per .
    -   **What will be achieved with this?**: Eliminerà la confusione attuale e renderà la pagina Corrispettivi un utile strumento di analisi dettagliata (es. con totali IVA, grafici, etc.), invece di una pagina vuota e inutile.
    -   **Status**: NOT STARTED
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on something**: No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P1) Correggere la logica di estrazione dei costi accessori per la **Flotta Auto** ().
    -   (P1) Ripristinare la funzionalità e i dati persi per gli **IBAN multipli** dei dipendenti ().
    -   (P2) Implementare i pulsanti Modifica ed Elimina per gli acconti dei dipendenti.
-   **Future Tasks**:
    -   Finalizzare l'importazione completa dei cedolini (upload PDF con salvataggio file).
    -   Unificare le anagrafiche  e .
    -   Integrazione Google Calendar.
    -   Dashboard Analytics.
    -   Report PDF via email.

**Completed work in this session**
-   **Refactoring Prima Nota**: Completata la separazione Cassa/Banca e implementato il saldo con riporto dall'anno precedente.
-   **Creazione Pagina Riconciliazione Cedolini**: Creata la nuova pagina  con stati di pagamento e modale per l'inserimento manuale.
-   **Migrazione Dati Stipendi**: I pagamenti storici degli stipendi sono stati migrati con successo nella nuova struttura dei cedolini.
-   **Fix Anagrafica Fornitori**: Corretti i fornitori senza nome tramite import da Excel e imposto l'uso del metodo di pagamento solo dall'anagrafica.
-   **Fix Import Corrispettivi**: Risolto il problema dei duplicati, chiarendo che i dati venivano importati correttamente ma visualizzati nel posto sbagliato.
-   **Fix Errore Pagamento Fatture (405)**: Aggiunto l'endpoint  mancante per registrare il pagamento di una fattura dalla dashboard.

**Earlier issues found/mentioned but not fixed**
-   Sincronizzazione ID Fattura su Assegni.
-   Inconsistenza nella visualizzazione delle fatture ().

**Known issue recurrence from previous fork**
-   Nessuna.

**Code Architecture**


**Key Technical Concepts**
-   **Refactoring Logica di Business**: Modifiche profonde e non standard alla logica contabile su richiesta esplicita dell'utente.
-   **Migrazione Dati**: Creazione di endpoint una tantum per spostare dati da una struttura obsoleta a una nuova (es.  -> ).
-   **Risoluzione Conflitti Dati**: La fonte di verità per il metodo di pagamento è stata fissata all'anagrafica fornitore, risolvendo conflitti con i dati presenti nei file XML.
-   **Codebase Inconsistente**: Il codice è ancora diviso tra  e . I file corrotti con Null Byte sono apparsi più volte.

**key DB schema**
-   ** / **: Collection separate per i due registri.
-   ****: Collection centrale per la gestione delle buste paga, ora arricchita con stato, importo pagato, e metodo di pagamento.
-   ****: Anagrafica fornitori, fonte di verità per il metodo di pagamento.
-   ****: Collection obsoleta. I nuovi dati vengono inseriti in .

**changes in tech stack**
- Nessuna.

**All files of reference**
-   
-   
-   
-   
-    (File fornito dall'utente per l'importazione dei fornitori).

**Areas that need refactoring**
-   **Struttura del Progetto**: È necessario finalizzare la migrazione da  a  per migliorare la manutenibilità.
-   **Collection **: Dovrebbe essere rimossa o archiviata per evitare confusione, dato che i dati ora risiedono in .

**key api endpoints**
-   : Endpoint (già eseguito) per la migrazione dati.
-   : Per importare/aggiornare fornitori da file Excel.
-   : Nuovo endpoint per segnare una fattura come pagata.
-   : Endpoint che importa i corrispettivi direttamente nella prima nota cassa.

**Critical Info for New Agent**
-   **L'utente ha ragione**: L'ultima segnalazione dell'utente (pagamenti banca in cassa) è corretta. È un bug critico da risolvere con priorità P0.
-   **Stick to the Plan**: L'agente precedente si è perso più volte, frustrando l'utente. Segui il piano, affronta un problema alla volta e comunica in modo chiaro.
-   **Fonte di Verità**: Il metodo di pagamento di un fornitore DEVE venire solo dall'anagrafica. I dati XML della fattura vanno ignorati per questa informazione.
-   **Architettura Corrispettivi**: I corrispettivi vengono importati in . La pagina  deve essere modificata per mostrare questi dati, non deve puntare a una collection separata.

**documents and test reports created in this job**
-    è stato aggiornato più volte.

**Last 10 User Messages and any pending HUMAN messages**
10. L'agente chiede se va bene unificare le viste dei corrispettivi.
9.  **Utente**: opzione 2 ma in prima nota cassa ci sono le fatture pagate per banca non stai filtrando il metodo pagamento associato ai dipendenti - **Segnalazione del bug critico.**
8.  **Agente**: Riconosce il bug e promette di correggerlo.
7.  **Utente**: Chiede perché la pagina corrispettivi esiste.
6.  **Agente**: Spiega che i dati sono in Prima Nota e propone di rimuovere la pagina o trasformarla in una vista filtrata.
5.  **Utente**: corrispettivi non importa ancora duplicati - **Segnalazione (errata) di un bug.**
4.  **Agente**: Spiega che la tech stack attuale è adeguata e chiede se l'utente ha riprovato a caricare i file.
3.  **Utente**: Chiede un confronto tra C++, Java e Python per il progetto.
2.  **Agente**: Chiede all'utente di riprovare a caricare i file XML dopo aver eliminato i vecchi record dal DB.
1.  **Utente**: Chiede di eliminare e ricaricare, ma sottolinea che il sistema dovrebbe gestire i duplicati correttamente.

**Project Health Check:**
-   **Broken**:
    -   La logica di registrazione dei pagamenti è parzialmente rotta, mescolando movimenti di cassa e banca.
-   **Technical Debt**:
    -   **High**: La struttura incoerente delle directory ( vs ).
    -   **Medium**: La coesistenza di una collection  inutilizzata crea confusione.

**3rd Party Integrations**
-   Nessuna nuova integrazione in questa sessione.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno.
-   **Known regressions**: Un nuovo bug critico è stato introdotto o scoperto: i pagamenti bancari vengono registrati in cassa.

**Credentials to test flow:**
Nessuna credenziale specifica necessaria.

**What agent forgot to execute**
-   L'agente non ha ancora affrontato le problematiche pendenti dalla sessione precedente, come la **Flotta Auto** e gli **IBAN multipli**, a causa delle nuove e urgenti richieste dell'utente.
-   Non ha completato il flusso end-to-end dell'importazione dei cedolini (manca il salvataggio del file PDF).</analysis>
