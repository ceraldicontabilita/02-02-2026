<analysis>Here is the summary of the previous session:

**original_problem_statement:**
L'utente, frustrato dalla perdita di dati tra i fork e dalla mancanza di progressi concreti, ha ridefinito radicalmente le priorità. Le richieste principali sono:

1.  **Architettura Dati Stabile (Bloccante)**: Divieto assoluto di salvare qualsiasi file o dato sul filesystem locale. Tutta la persistenza dei dati, inclusi i file PDF (come Base64), deve avvenire esclusivamente su MongoDB Atlas per garantire la continuità tra le sessioni. Questa logica deve essere applicata retroattivamente e sistematicamente a tutta l'applicazione.
2.  **Automazione Contabile (Learning Machine)**: L'obiettivo primario dell'app è diventare un sistema di automazione contabile. Deve scaricare documenti (es. cedolini, fatture), leggerne il contenuto (parsing), estrarre i dati rilevanti e creare automaticamente le scritture contabili corrispondenti (es. in ).
3.  **Gestione Documenti Non Associati**: Creare un'interfaccia utente per gestire i documenti che il sistema non riesce ad associare automaticamente. Questa UI deve fornire proposte intelligenti (es. anno, entità) e permettere all'utente di associare manualmente i file a record esistenti o di crearne di nuovi.
4.  **Standardizzazione UI/UX**: Eliminare codice e pagine con la vecchia grafica. Tutte le nuove interfacce devono seguire lo stile moderno e mobile-first della pagina .
5.  **Ottimizzazione Sync Email**: Dopo il download massivo iniziale, il sistema deve essere configurato per sincronizzare solo le email dell'ultimo giorno per rendere le operazioni future più veloci.

**User's preferred language**: Italiano

**what currently exists?**
Un'applicazione full-stack (FastAPI + React) il cui core è stato rifattorizzato per aderire alla nuova architettura MongoDB-first.
- **Servizio di Ingestione Email su MongoDB**: Il servizio di download email è stato modificato per salvare il contenuto dei PDF come stringhe Base64 direttamente in varie collezioni su MongoDB (, , etc.), eliminando la dipendenza dal filesystem locale.
- **Automazione Contabile per Cedolini**: È stata implementata e affinata una funzionalità che processa i cedolini PDF scaricati, ne estrae i dati (dipendente, periodo, netto, codice fiscale) tramite parsing del testo, e crea automaticamente **152 registrazioni** nella collezione .
- **UI per Gestione Documenti Non Associati**: È stata creata una nuova pagina () che permette all'utente di visualizzare i documenti non associati e di collegarli manualmente. L'interfaccia include un pannello di proposta intelligente che suggerisce associazioni basate sui dati estratti dal file.
- **Standard di Design**: La grafica della nuova pagina  è stata allineata a quella di . È stato creato un file  per documentare lo stile.
- **Sync Email Incrementale**: Il servizio di download è stato modificato per default a sincronizzare solo le email dell'ultimo giorno.

**Last working item**:
-   **Last item agent was working**: L'agente stava eseguendo un audit sistematico del codebase per applicare la logica MongoDB-only a tutti gli endpoint rimanenti, come richiesto esplicitamente dall'utente. Aveva identificato una lista di file critici (, , ) che ancora utilizzavano  e il filesystem locale e aveva iniziato la rifattorizzazione di .
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: backend testing agent. Una volta completata la rifattorizzazione di tutti i file del backend, è necessario un test di regressione completo per assicurarsi che nessuna funzionalità sia stata interrotta.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: Audit e Refactoring Completo per Architettura MongoDB (P0)**
    -   **Description**: Diversi file nel backend contengono ancora logiche che leggono o scrivono sul filesystem locale (), contravvenendo alla richiesta critica dell'utente. Questa è la principale causa di instabilità e perdita di dati.
    -   **Attempted fixes**: Gli endpoint di ingestione email, upload quietanze () e una parte di  sono già stati rifattorizzati.
    -   **Next debug checklist**:
        1.  Completare la rifattorizzazione di .
        2.  Rifattorizzare  per usare  da MongoDB.
        3.  Rifattorizzare  per generare e restituire i PDF in memoria, senza salvarli su file.
        4.  Eseguire una ricerca globale per , ,  per identificare e correggere ogni istanza rimanente di accesso al filesystem.
    -   **Why fix this issue and what will be achieved with the fix?**: Risolverà la richiesta più critica dell'utente, garantendo la persistenza dei dati e la stabilità dell'applicazione tra i fork.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: None

**In progress Task List**:
-   **Task 1: Completare il Refactoring Sistematico (P0)**
    -   **Where to resume**: Continuare il refactoring del file , assicurandosi che tutti gli endpoint di lettura e scrittura di documenti operino su MongoDB. Successivamente, procedere con gli altri file identificati nella checklist dell'Issue 1.
    -   **What will be achieved with this?**: L'intera applicazione aderirà al principio MongoDB-only, rendendola robusta e stateful.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on something**: None

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **(P1) Migliorare Associazione Intelligente**:
        -   **Associazione Anno F24**: La logica di associazione degli F24 non popola correttamente il campo . È necessario migliorare il parser per estrarre l'anno dal nome del file o dal contenuto.
        -   **Estensione Learning Machine**: Estendere la logica di parsing e creazione automatica di scritture contabili anche alle fatture e agli F24, non solo ai cedolini.
    -   **(P1) Pulizia UI e Codice**: L'utente ha chiesto di *eliminare* le vecchie pagine complesse, non solo di nasconderle. Bisogna identificare le sezioni dell'UI rese obsolete dalle nuove interfacce e rimuoverle completamente dal codice (componenti React, route, endpoint API non più usati).
-   **Future Tasks**:
    -   **(P2) Riprendere il Refactoring Strutturale**: Una volta stabilizzata l'architettura dati, riprendere il task originale di suddividere i router monolitici (come ) in file più piccoli e manutenibili.

**Completed work in this session**
-   **Architettura MongoDB-First Implementata**: Il servizio di ingestione email è stato completamente riscritto per salvare i PDF come dati Base64 su MongoDB Atlas, eliminando la scrittura su filesystem.
-   **Migrazione Dati Esistenti**: Creato ed eseguito uno script per migrare 63 PDF esistenti dal filesystem a MongoDB.
-   **Automazione Contabile Cedolini**: Implementata una pipeline che analizza i PDF dei cedolini, ne estrae i dati chiave e crea automaticamente **152 scritture contabili** in .
-   **Fix Credenziali per Task in Background**: Risolto un bug critico che impediva ai task in background (es. download email) di accedere alle credenziali, garantendone l'esecuzione affidabile.
-   **Creazione UI Gestione Documenti**: Sviluppata la pagina  per la gestione manuale dei file non associati, completa di proposte intelligenti per assistere l'utente.
-   **Standardizzazione e Documentazione UI**: La nuova pagina è stata allineata graficamente al resto dell'app e le linee guida di design sono state salvate in .
-   **Configurazione Sync Email Incrementale**: Il download email ora processa solo l'ultimo giorno di default, per ottimizzare le performance.
-   **Refactoring Parziale del Codice Legacy**: Diversi endpoint (es. ) sono già stati aggiornati per non dipendere più dal filesystem.

**Code Architecture**


**Key Technical Concepts**
-   **MongoDB as Primary Storage**: Architettura basata sul salvataggio di dati binari (PDF come Base64) in MongoDB per garantire la persistenza.
-   **PDF Parsing (PyMuPDF)**: Estrazione di testo da documenti PDF per automatizzare l'inserimento dati.
-   **Data Extraction with Regex**: Utilizzo intensivo di espressioni regolari per identificare e estrarre dati specifici (nomi, date, importi) da testo non strutturato.
-   **Systemic Code Refactoring**: Applicazione di un cambiamento architetturale (rimozione del filesystem) in modo sistematico attraverso l'intera codebase.

**key DB schema**
-   ****: Collezione per i documenti scaricati in attesa di associazione manuale. Contiene il campo .
-   ****: Collezione per i cedolini scaricati. Contiene  e  dopo l'elaborazione.
-   ****: Collezione delle scritture contabili, ora popolata automaticamente dal servizio di parsing con un campo .
-   ****: Collezione delle fatture, confermata come destinazione per l'importazione di file XML.

**All files of reference**
-    (Core per download email su MongoDB)
-    (Core per parsing e logiche di associazione)
-    (Nuova UI di riferimento)
-    (Guida di stile)
-    (File critico in fase di refactoring)

**Areas that need refactoring**:
-   
-   
-   
-   Qualsiasi altro file che contenga riferimenti a  o operazioni di scrittura su disco.

**key api endpoints**
-   : Avvia la sincronizzazione delle email.
-   : Restituisce la lista dei documenti da associare.
-   : Esegue l'associazione manuale di un documento.
-   : Avvia l'elaborazione dei cedolini per la creazione automatica delle scritture contabili.

**Critical Info for New Agent**
-   **Priorità Assoluta: MongoDB Atlas per TUTTO**. Non salvare mai nulla sul filesystem locale. È il requisito fondamentale dell'utente per garantire la persistenza dei dati. Applica questa regola a tutto il codice, sia nuovo che esistente.
-   **L'Obiettivo è l'Automazione (Learning Machine)**: Il valore principale dell'app per l'utente è la sua capacità di automatizzare la contabilità. Il lavoro fatto sui cedolini è il modello da replicare per fatture, F24 e altri documenti.
-   **Segui le Linee Guida di Design**: Tutte le nuove pagine frontend devono aderire allo stile di , documentato in . Il vecchio stile grafico è deprecato.
-   **Approccio Sistematico**: L'utente si aspetta che le correzioni e le nuove logiche siano applicate in modo coerente a tutta l'applicazione. Esegui audit e ricerche globali per garantire uniformità.
-   **L'utente è frustrato ma ha dato una direzione chiara**: Segui le ultime istruzioni con precisione. La priorità è completare il refactoring architetturale e potenziare le capacità di automazione.

**documents and test reports created in this job**
-   
-   
-   
-    (creato ma poi superato da altre logiche)
-    (creato ma poi superato da altre logiche)

**Last 10 User Messages and any pending HUMAN messages**
-   : Procedi - Approvazione per continuare con il refactoring sistematico.
-   : **Richiesta chiave:** Applica la logica MongoDB a TUTTO il resto dell'app, imposta il sync email a 1 giorno, e rifai la grafica della pagina Documenti non associati usando lo stile nuovo, registrandolo da qualche parte.
-   : Riepilogo di conferma per l'utente, mostrando la nuova pagina e le funzionalità di associazione intelligente.
-   : Chiede conferma che l'associazione intelligente funzioni per anno e per tutti i tipi di documento (F24, cartelle) e che l'upload di XML segua la stessa logica di salvataggio su MongoDB. Fornisce specifiche dettagliate per la UI di associazione manuale.
-   : Riepilogo finale del lavoro svolto.
-   : **Punto di svolta:** Esprime grande frustrazione. Vieta esplicitamente l'uso del filesystem e ordina che tutto venga salvato su MongoDB Atlas. Definisce l'obiettivo dell'app: essere una learning machine che automatizza la contabilità partendo dai PDF.
-   : L'agente chiede scusa e chiede chiarimenti.
-   : Critica il lavoro fatto, la spesa, e la mancanza di risultati concreti. Ordina di eliminare le pagine complesse e di riorganizzare la UI in modo logico. Ribadisce il problema della perdita di dati tra i fork.

**Project Health Check:**
-   **Broken**: Diverse parti dell'applicazione (es. in ) si basano ancora sull'accesso al filesystem locale, un'architettura che l'utente ha esplicitamente vietato e che causa la perdita di dati.
-   **Mocked**: Nessuno.

**3rd Party Integrations**
-   Nessuna.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno
-   **Known regressions**: Nessuna nota, ma il refactoring in corso è ad alto rischio di regressione se non testato a fondo.

**Credentials to test flow:**
Le credenziali per MongoDB e Gmail si trovano nei file  del backend.

**What agent forgot to execute**
L'agente non ha dimenticato compiti, ma ha dovuto correggere la propria rotta più volte in base al feedback sempre più specifico e frustrato dell'utente. Il compito principale dimenticato inizialmente era il requisito fondamentale di non usare il filesystem, che è ora il focus principale del lavoro.</analysis>
